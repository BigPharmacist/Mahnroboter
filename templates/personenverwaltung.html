{% extends "base.html" %}

{% block title %}Personenverwaltung{% endblock %}

{% block content %}
<header>
  <h1>Personenverwaltung</h1>
  <p class="subtitle">Verwaltung von Kundendaten und Kontaktinformationen</p>
</header>

<section class="stats-and-search">
  <div class="stat-card-compact">
    <div class="stat-label">Anzahl Kunden</div>
    <div class="stat-value" id="customer-count">{{ customers|length }}</div>
  </div>
  <div class="search-container">
    <input type="text"
           id="customer-search"
           class="search-input"
           placeholder="üîç Kunden suchen (Name, Adresse, Email)..."
           onkeyup="filterCustomers()">
  </div>
  <div class="filter-toggle">
    <label class="toggle-label">
      <input type="checkbox" id="filter-no-salutation" onchange="filterCustomers()">
      <span>Nur ohne Anrede</span>
    </label>
  </div>
</section>

<section class="action-bar">
  <button class="btn btn-primary btn-lg" onclick="saveAllChanges()">
    Alle √Ñnderungen speichern
  </button>
  <button class="btn btn-secondary btn-lg" onclick="determineSalutations()" style="margin-left: 1rem;">
    ü§ñ Anreden automatisch ermitteln (AI)
  </button>
  <span id="ai-status" class="ai-status"></span>
</section>

{% if customers %}
<section class="customers-table-container">
  <table class="customers-table">
    <thead>
      <tr>
        <th class="sortable" data-sort="index" data-type="number"># <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="salutation" data-type="string">Anrede <span class="sort-arrow"></span></th>
        <th class="sortable sort-asc" data-sort="name" data-type="string">Name <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="address" data-type="string">Adresse <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="email" data-type="string">Email <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="notes" data-type="string">Bemerkungen <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="never_remind" data-type="checkbox">Nie mahnen! <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="bank_debit" data-type="checkbox">Bankeinzug <span class="sort-arrow"></span></th>
        <th class="sortable" data-sort="print_only" data-type="checkbox">Nur Drucken <span class="sort-arrow"></span></th>
      </tr>
    </thead>
    <tbody>
      {% for customer in customers %}
      <tr data-customer="{{ customer.customer_name }}">
        <td class="row-number">{{ loop.index }}</td>
        <td>
          <select class="form-input salutation-input" data-customer="{{ customer.customer_name }}">
            <option value="">-</option>
            <option value="Herr" {% if customer.salutation == 'Herr' %}selected{% endif %}>Herr</option>
            <option value="Frau" {% if customer.salutation == 'Frau' %}selected{% endif %}>Frau</option>
            <option value="Familie" {% if customer.salutation == 'Familie' %}selected{% endif %}>Familie</option>
          </select>
        </td>
        <td>
          <strong>{{ customer.customer_name }}</strong>
        </td>
        <td>
          <small class="muted">{{ customer.customer_address }}</small>
        </td>
        <td>
          <input type="email"
                 class="form-input email-input"
                 value="{{ customer.email }}"
                 placeholder="email@example.com"
                 data-customer="{{ customer.customer_name }}">
        </td>
        <td>
          <textarea class="form-input notes-input"
                    rows="1"
                    placeholder="Bemerkungen..."
                    data-customer="{{ customer.customer_name }}">{{ customer.notes }}</textarea>
        </td>
        <td class="text-center">
          <input type="checkbox"
                 class="never-remind-checkbox"
                 data-customer="{{ customer.customer_name }}"
                 {% if customer.never_remind %}checked{% endif %}>
        </td>
        <td class="text-center">
          <input type="checkbox"
                 class="bank-debit-checkbox"
                 data-customer="{{ customer.customer_name }}"
                 {% if customer.bank_debit %}checked{% endif %}>
        </td>
        <td class="text-center">
          <input type="checkbox"
                 class="print-only-checkbox"
                 data-customer="{{ customer.customer_name }}"
                 {% if customer.print_only %}checked{% endif %}>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% else %}
<section class="empty-state">
  <div class="info-card">
    <span class="info-icon">‚ÑπÔ∏è</span>
    <div class="info-content">
      <h2>Keine Kunden</h2>
      <p>Es wurden noch keine Kunden erfasst.</p>
    </div>
  </div>
</section>
{% endif %}

<script>
async function saveAllChanges() {
  const rows = document.querySelectorAll('tr[data-customer]');
  const saveButton = document.querySelector('.action-bar button');

  // Disable button during save
  saveButton.disabled = true;
  const originalText = saveButton.textContent;
  saveButton.textContent = 'Speichert...';

  let successCount = 0;
  let errorCount = 0;

  for (const row of rows) {
    const customerName = row.getAttribute('data-customer');
    const salutation = row.querySelector('.salutation-input').value;
    const email = row.querySelector('.email-input').value;
    const notes = row.querySelector('.notes-input').value;
    const neverRemind = row.querySelector('.never-remind-checkbox').checked;
    const bankDebit = row.querySelector('.bank-debit-checkbox').checked;
    const printOnly = row.querySelector('.print-only-checkbox').checked;

    try {
      const response = await fetch(`/api/customers/${encodeURIComponent(customerName)}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          salutation: salutation,
          email: email,
          notes: notes,
          never_remind: neverRemind,
          bank_debit: bankDebit,
          print_only: printOnly
        })
      });

      const data = await response.json();

      if (data.success) {
        successCount++;
      } else {
        errorCount++;
        console.error(`Fehler bei ${customerName}:`, data.error);
      }
    } catch (error) {
      errorCount++;
      console.error(`Fehler bei ${customerName}:`, error);
    }
  }

  // Re-enable button
  saveButton.disabled = false;

  // Show success feedback
  if (errorCount === 0) {
    saveButton.textContent = '‚úì Alle √Ñnderungen gespeichert';
    saveButton.style.background = '#28a745';
    saveButton.classList.remove('btn-unsaved');

    setTimeout(() => {
      saveButton.textContent = originalText;
      saveButton.style.background = '';
    }, 2000);
  } else {
    saveButton.textContent = originalText;
    saveButton.classList.remove('btn-unsaved');
    alert(`${successCount} Kunden erfolgreich gespeichert, ${errorCount} Fehler aufgetreten. Details in der Konsole.`);
  }
}

async function determineSalutations() {
  const aiButton = document.querySelectorAll('.action-bar button')[1];
  const aiStatus = document.getElementById('ai-status');

  // Confirm before starting
  if (!confirm('M√∂chten Sie die Anreden f√ºr alle Kunden ohne Anrede automatisch per AI ermitteln lassen?')) {
    return;
  }

  // Disable button during processing
  aiButton.disabled = true;
  const originalText = aiButton.textContent;
  aiButton.textContent = '‚è≥ Ermittle Anreden...';
  aiStatus.textContent = '';
  aiStatus.className = 'ai-status';

  try {
    const response = await fetch('/api/determine-salutations', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    const data = await response.json();

    if (data.success) {
      if (data.success_count > 0) {
        aiStatus.textContent = `‚úì ${data.success_count} von ${data.total} Anrede(n) ermittelt!`;
        aiStatus.className = 'ai-status success';

        // Update the table with new salutations
        if (data.results) {
          data.results.forEach(result => {
            if (result.status === 'success') {
              const row = document.querySelector(`tr[data-customer="${result.customer_name}"]`);
              if (row) {
                const select = row.querySelector('.salutation-input');
                if (select) {
                  select.value = result.salutation;
                }
              }
            }
          });
        }

        // Reload page after a short delay to show updated data
        setTimeout(() => window.location.reload(), 2000);
      } else {
        aiStatus.textContent = '‚úì Keine neuen Anreden ermittelt.';
        aiStatus.className = 'ai-status info';
      }

      if (data.failed_count > 0) {
        console.warn('Fehlerhafte Ermittlungen:', data.results.filter(r => r.status === 'failed'));
      }
    } else {
      aiStatus.textContent = '‚úó Fehler: ' + (data.error || 'Unbekannter Fehler');
      aiStatus.className = 'ai-status error';
    }
  } catch (error) {
    aiStatus.textContent = '‚úó Netzwerkfehler: ' + error.message;
    aiStatus.className = 'ai-status error';
  } finally {
    // Re-enable button
    aiButton.disabled = false;
    aiButton.textContent = originalText;
  }
}

// Mark save button as "unsaved" when any change is made
function markAsUnsaved() {
  const saveButton = document.querySelector('.action-bar .btn-primary');
  if (saveButton) {
    saveButton.classList.add('btn-unsaved');
  }
}

// Add event listeners to all input fields
document.addEventListener('DOMContentLoaded', function() {
  // Listen to all inputs
  const salutationInputs = document.querySelectorAll('.salutation-input');
  const emailInputs = document.querySelectorAll('.email-input');
  const notesInputs = document.querySelectorAll('.notes-input');
  const neverRemindCheckboxes = document.querySelectorAll('.never-remind-checkbox');
  const bankDebitCheckboxes = document.querySelectorAll('.bank-debit-checkbox');
  const printOnlyCheckboxes = document.querySelectorAll('.print-only-checkbox');

  salutationInputs.forEach(input => input.addEventListener('change', markAsUnsaved));
  emailInputs.forEach(input => input.addEventListener('input', markAsUnsaved));
  notesInputs.forEach(input => input.addEventListener('input', markAsUnsaved));
  neverRemindCheckboxes.forEach(input => input.addEventListener('change', markAsUnsaved));
  bankDebitCheckboxes.forEach(input => input.addEventListener('change', markAsUnsaved));
  printOnlyCheckboxes.forEach(input => input.addEventListener('change', markAsUnsaved));
});

// Filter customers based on search input and filters
function filterCustomers() {
  const searchInput = document.getElementById('customer-search');
  const filter = searchInput.value.toLowerCase();
  const noSalutationFilter = document.getElementById('filter-no-salutation').checked;
  const table = document.querySelector('.customers-table');
  const rows = table.querySelectorAll('tbody tr');

  let visibleCount = 0;

  rows.forEach(row => {
    const customerName = row.querySelector('strong').textContent.toLowerCase();
    const address = row.querySelector('.muted').textContent.toLowerCase();
    const emailInput = row.querySelector('.email-input');
    const email = emailInput ? emailInput.value.toLowerCase() : '';
    const salutationSelect = row.querySelector('.salutation-input');
    const hasSalutation = salutationSelect && salutationSelect.value !== '';

    // Check search filter
    const matchesSearch = customerName.includes(filter) || address.includes(filter) || email.includes(filter);

    // Check no-salutation filter
    const matchesSalutationFilter = !noSalutationFilter || !hasSalutation;

    if (matchesSearch && matchesSalutationFilter) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });

  // Update row numbers for visible rows
  let index = 1;
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      const rowNumber = row.querySelector('.row-number');
      if (rowNumber) {
        rowNumber.textContent = index++;
      }
    }
  });

  // Update customer count
  document.getElementById('customer-count').textContent = visibleCount;
}

// Table sorting functionality
let currentSort = { column: 'name', direction: 'asc' };

function sortTable(column, type) {
  const table = document.querySelector('.customers-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const headers = table.querySelectorAll('th.sortable');

  // Determine sort direction
  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'asc';
  }

  // Update header classes
  headers.forEach(th => {
    th.classList.remove('sort-asc', 'sort-desc');
    if (th.dataset.sort === column) {
      th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
    }
  });

  // Get value from row based on column
  function getValue(row, col) {
    switch(col) {
      case 'index':
        return parseInt(row.querySelector('.row-number').textContent) || 0;
      case 'salutation':
        return row.querySelector('.salutation-input').value.toLowerCase();
      case 'name':
        return row.querySelector('strong').textContent.toLowerCase();
      case 'address':
        return row.querySelector('.muted').textContent.toLowerCase();
      case 'email':
        return row.querySelector('.email-input').value.toLowerCase();
      case 'notes':
        return row.querySelector('.notes-input').value.toLowerCase();
      case 'never_remind':
        return row.querySelector('.never-remind-checkbox').checked ? 1 : 0;
      case 'bank_debit':
        return row.querySelector('.bank-debit-checkbox').checked ? 1 : 0;
      case 'print_only':
        return row.querySelector('.print-only-checkbox').checked ? 1 : 0;
      default:
        return '';
    }
  }

  // Sort rows
  rows.sort((a, b) => {
    let valA = getValue(a, column);
    let valB = getValue(b, column);

    // For name column, sort by last name (last word)
    if (column === 'name') {
      const getLastName = (name) => {
        const parts = name.trim().split(/\s+/);
        return parts[parts.length - 1] || '';
      };
      valA = getLastName(valA);
      valB = getLastName(valB);
    }

    let comparison = 0;
    if (type === 'number' || type === 'checkbox') {
      comparison = valA - valB;
    } else {
      comparison = valA.localeCompare(valB, 'de');
    }

    return currentSort.direction === 'asc' ? comparison : -comparison;
  });

  // Re-append rows in sorted order
  rows.forEach(row => tbody.appendChild(row));

  // Update row numbers
  updateRowNumbers();
}

function updateRowNumbers() {
  const table = document.querySelector('.customers-table');
  const rows = table.querySelectorAll('tbody tr');
  let index = 1;
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      const rowNumber = row.querySelector('.row-number');
      if (rowNumber) {
        rowNumber.textContent = index++;
      }
    }
  });
}

// Add click handlers to sortable headers
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', function() {
      sortTable(this.dataset.sort, this.dataset.type);
    });
  });
});
</script>

<style>
.action-bar {
  margin: 2rem 0;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.ai-status {
  font-size: 0.875rem;
  margin-left: 1rem;
}

.ai-status.success {
  color: #28a745;
  font-weight: 600;
}

.ai-status.error {
  color: #dc3545;
  font-weight: 600;
}

.ai-status.info {
  color: #17a2b8;
  font-weight: 600;
}

.stats-and-search {
  display: flex;
  gap: 1rem;
  margin: 2rem 0;
  align-items: center;
}

.stat-card-compact {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  min-width: 180px;
  flex-shrink: 0;
}

.search-container {
  flex: 1;
  max-width: 600px;
}

.search-input {
  width: 100%;
  padding: 1rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.2s;
  background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.search-input:focus {
  outline: none;
  border-color: #123C69;
  box-shadow: 0 0 0 3px rgba(18, 60, 105, 0.1);
}

.filter-toggle {
  display: flex;
  align-items: center;
  background: white;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-size: 0.9rem;
  white-space: nowrap;
  user-select: none;
}

.toggle-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.stat-label {
  font-size: 0.875rem;
  color: #666;
  line-height: 1.4;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: #123C69;
  line-height: 1;
}

.customers-table-container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: auto;
  margin: 2rem 0;
  max-height: calc(100vh - 280px);
}

.customers-table thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

.customers-table {
  width: 100%;
  border-collapse: collapse;
}

.customers-table th {
  background: #f8f9fa;
  padding: 0.5rem 0.75rem;
  text-align: left;
  font-weight: 600;
  color: #333;
  border-bottom: 2px solid #e0e0e0;
  font-size: 0.85rem;
}

.customers-table th.sortable {
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}

.customers-table th.sortable:hover {
  background: #e9ecef;
}

.customers-table th.sortable .sort-arrow {
  display: inline-block;
  width: 0;
  height: 0;
  margin-left: 4px;
  vertical-align: middle;
  opacity: 0.3;
}

.customers-table th.sortable .sort-arrow::after {
  content: "‚Üï";
  font-size: 0.75rem;
}

.customers-table th.sortable.sort-asc .sort-arrow::after {
  content: "‚ñ≤";
  opacity: 1;
}

.customers-table th.sortable.sort-desc .sort-arrow::after {
  content: "‚ñº";
  opacity: 1;
}

.customers-table th.sortable.sort-asc .sort-arrow,
.customers-table th.sortable.sort-desc .sort-arrow {
  opacity: 1;
}

.customers-table td {
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid #e0e0e0;
  vertical-align: middle;
}

.customers-table tbody tr:hover {
  background: #f8f9fa;
}

.form-input {
  width: 100%;
  padding: 0.4rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.85rem;
  font-family: inherit;
}

.form-input:focus {
  outline: none;
  border-color: #123C69;
  box-shadow: 0 0 0 2px rgba(18, 60, 105, 0.1);
}

.email-input {
  width: 100%;
  max-width: 250px;
}

.notes-input {
  width: 100%;
  max-width: 300px;
  resize: vertical;
}

.text-center {
  text-align: center;
}

.never-remind-checkbox,
.bank-debit-checkbox,
.print-only-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.amount {
  font-weight: 600;
  text-align: right;
}

.muted {
  color: #6c757d;
  font-size: 0.875rem;
}

.btn {
  padding: 0.5rem 1rem;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-size: 0.875rem;
  transition: all 0.2s;
}

.btn-primary {
  background: #123C69;
  color: white;
}

.btn-primary:hover {
  background: #0d2d4f;
}

.btn-unsaved {
  background: #dc3545 !important;
  animation: pulse 2s infinite;
}

.btn-unsaved:hover {
  background: #c82333 !important;
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(220, 53, 69, 0);
  }
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.813rem;
}

.btn-lg {
  padding: 0.75rem 2rem;
  font-size: 1rem;
  font-weight: 600;
}

.empty-state {
  margin: 3rem 0;
}

.info-card {
  background: white;
  padding: 3rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  text-align: center;
}

.info-icon {
  font-size: 4rem;
  display: block;
  margin-bottom: 1rem;
}

.info-content h2 {
  margin: 1rem 0;
  color: #333;
}

.info-content p {
  color: #666;
  line-height: 1.6;
}
</style>

{% endblock %}
