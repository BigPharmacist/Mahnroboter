{% extends "base.html" %}

{% block title %}Rechnungs√ºbersicht{% endblock %}

{% block content %}
<div class="sticky-header">
  <header>
    <h1>Apotheken-Rechnungen</h1>
    <p class="subtitle">Anzeige der {{ limit }} zuletzt erfassten Rechnungen.</p>
  </header>

  <div class="scan-controls">
    <button id="scan-button" class="scan-button">&#x1F50D; Neu Importieren</button>
    <button id="pending-imports-button" class="scan-button" style="background-color: #ff6b35; margin-left: 0.5rem; display: none;">
      ‚ö†Ô∏è Pending Imports <span id="pending-imports-badge" class="filter-badge"></span>
    </button>
    <form method="get" class="search-form" style="display: inline-flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
      <label for="q">Suche</label>
      <input type="text" id="q" name="q" value="{{ query }}" placeholder="Name, Rechnungsnummer oder Adresse">
      <input type="hidden" name="grouped" value="{{ 'true' if grouped else 'false' }}">
      <input type="hidden" name="sort" value="{{ sort_by }}">
      <input type="hidden" name="direction" value="{{ sort_direction }}">
      <input type="hidden" name="time" value="{{ time_filter }}">
      <input type="hidden" name="status" value="{{ status_filter }}">
      <input type="hidden" name="email" value="{{ email_filter }}">
      <input type="hidden" name="uncollectible" value="{{ uncollectible_filter }}">
      <input type="hidden" name="invoice_date" value="{{ invoice_date_filter }}">
      <button type="submit">Filtern</button>
      {% if query %}
      <a class="reset" href="{{ url_for('index', time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort=sort_by, direction=sort_direction) }}">Suche zur√ºcksetzen</a>
      {% endif %}
    </form>
    <span id="scan-status" class="scan-status"></span>
    <!-- Filter Button - rechts oben -->
    <button type="button" class="filter-toggle-btn filter-toggle-btn-header" onclick="toggleFilterModal()">
      üîç Filter
      {% if invoice_date_filter != 'all' or status_filter != 'open' or email_filter != 'all' or uncollectible_filter != 'hide' %}
      <span class="filter-badge">aktiv</span>
      {% endif %}
    </button>
  </div>

  <section class="controls">
    <div class="filter-grid">
      <!-- Snapshot Buttons -->
      <div class="filter-row snapshot-row">
        <label class="filter-label">Snapshot:</label>
        <div class="filter-buttons">
          <a href="{{ url_for('index', q=query, time='all', status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort=sort_by, direction=sort_direction) }}"
             class="filter-btn {% if time_filter == 'all' %}active{% endif %}">
            üìã Alle Monate
          </a>
          <a href="{{ url_for('index', q=query, time='current_month', status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort=sort_by, direction=sort_direction) }}"
             class="filter-btn {% if time_filter == 'current_month' %}active{% endif %}">
            {% if time_filter == 'current_month' and latest_snapshot %}
              üìÖ {{ latest_snapshot.split('-')[1] }}/{{ latest_snapshot.split('-')[0] }}
            {% else %}
              üìÖ Aktueller Monat
            {% endif %}
          </a>
        </div>

        <!-- Custom Date Range immer sichtbar -->
        <form method="get" class="date-range-form-inline">
          <input type="hidden" name="q" value="{{ query }}">
          <input type="hidden" name="time" value="custom">
          <input type="hidden" name="status" value="{{ status_filter }}">
          <input type="hidden" name="email" value="{{ email_filter }}">
          <input type="hidden" name="uncollectible" value="{{ uncollectible_filter }}">
          <input type="hidden" name="invoice_date" value="{{ invoice_date_filter }}">
          <input type="hidden" name="grouped" value="{{ 'true' if grouped else 'false' }}">
          <input type="hidden" name="sort" value="{{ sort_by }}">
          <input type="hidden" name="direction" value="{{ sort_direction }}">

          <label for="from_month" class="date-label-inline">Von:</label>
          <input type="text" id="from_month" name="from_month_display"
                 value="{% if from_month %}{{ from_month.split('-')[1] }}.{{ from_month.split('-')[0] }}{% elif min_month %}{{ min_month.split('-')[1] }}.{{ min_month.split('-')[0] }}{% endif %}"
                 placeholder="MM.JJJJ"
                 pattern="\d{2}\.\d{4}"
                 class="month-input month-input-text">

          <label for="to_month" class="date-label-inline">Bis:</label>
          <input type="text" id="to_month" name="to_month_display"
                 value="{% if to_month %}{{ to_month.split('-')[1] }}.{{ to_month.split('-')[0] }}{% elif max_month %}{{ max_month.split('-')[1] }}.{{ max_month.split('-')[0] }}{% endif %}"
                 placeholder="MM.JJJJ"
                 pattern="\d{2}\.\d{4}"
                 class="month-input month-input-text">

          <button type="submit" class="apply-btn-inline">Anwenden</button>
        </form>
      </div>

    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="filter-modal">
      <div class="filter-modal-content">
        <div class="filter-modal-header">
          <h3>Filter</h3>
          <span class="filter-modal-close" onclick="toggleFilterModal()">&times;</span>
        </div>
        <div class="filter-modal-body">
          <!-- Rechnungsdatum Filter Buttons -->
          <div class="filter-row">
            <label class="filter-label">Rechnungsdatum:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if invoice_date_filter == 'all' %}active{% endif %}"
                      data-filter="invoice_date" data-value="all">
                üìã Alle
              </button>
              <button type="button" class="filter-btn {% if invoice_date_filter == 'current_month' %}active{% endif %}"
                      data-filter="invoice_date" data-value="current_month">
                üìÖ Aktueller Monat
              </button>
              <button type="button" class="filter-btn {% if invoice_date_filter == 'previous_month' %}active{% endif %}"
                      data-filter="invoice_date" data-value="previous_month">
                üìÜ Vormonat
              </button>
            </div>
          </div>

          <!-- Status Buttons -->
          <div class="filter-row">
            <label class="filter-label">Status:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if status_filter == 'all' %}active{% endif %}"
                      data-filter="status" data-value="all">
                üìã Alle
              </button>
              <button type="button" class="filter-btn {% if status_filter == 'open' %}active{% endif %}"
                      data-filter="status" data-value="open">
                ‚ö† Nur Offene
              </button>
              <button type="button" class="filter-btn {% if status_filter == 'paid' %}active{% endif %}"
                      data-filter="status" data-value="paid">
                ‚úì Nur Bezahlte
              </button>
            </div>
          </div>

          <!-- Email Filter Buttons -->
          <div class="filter-row">
            <label class="filter-label">Email:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if email_filter == 'all' %}active{% endif %}"
                      data-filter="email" data-value="all">
                üìã Alle
              </button>
              <button type="button" class="filter-btn {% if email_filter == 'with_email' %}active{% endif %}"
                      data-filter="email" data-value="with_email">
                ‚úâ Mit Email
              </button>
              <button type="button" class="filter-btn {% if email_filter == 'without_email' %}active{% endif %}"
                      data-filter="email" data-value="without_email">
                ‚úó Ohne Email
              </button>
            </div>
          </div>

          <!-- Uncollectible Filter Buttons -->
          <div class="filter-row">
            <label class="filter-label">Uneinbringbar:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if uncollectible_filter == 'hide' %}active{% endif %}"
                      data-filter="uncollectible" data-value="hide">
                üö´ Ausblenden
              </button>
              <button type="button" class="filter-btn {% if uncollectible_filter == 'show' %}active{% endif %}"
                      data-filter="uncollectible" data-value="show">
                üëÅ Anzeigen
              </button>
              <button type="button" class="filter-btn {% if uncollectible_filter == 'only' %}active{% endif %}"
                      data-filter="uncollectible" data-value="only">
                ‚ö†Ô∏è Nur Uneinbringbare
              </button>
            </div>
          </div>
        </div>
        <div class="filter-modal-footer">
          <button type="button" class="filter-reset-btn" onclick="resetFilters()">Zur√ºcksetzen</button>
          <button type="button" class="filter-apply-btn" onclick="applyFilters()">Anwenden</button>
        </div>
      </div>
    </div>
    <div class="action-buttons-container">
      <div class="action-buttons-grid">
        <button id="print-button" class="print-button action-btn">&#x1F5A8; Rechnungen drucken ({{ invoices|length }})</button>
        <button id="email-button" class="email-button action-btn">&#x2709; Rechnungen per E-Mail versenden ({{ invoices|length }})</button>
        <button id="collective-button" class="collective-button action-btn">&#x1F4C4; Sammelrechnungen erzeugen</button>
        <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='false' if grouped else 'true', sort=sort_by, direction=sort_direction) }}" class="toggle-button action-btn">
          {% if grouped %}
          &#x1F4CB; Normale Ansicht
          {% else %}
          &#x1F465; Nach Empf√§nger gruppieren
          {% endif %}
        </a>
      </div>
      <div class="action-status">
        <span id="email-status" class="email-status"></span>
        <span id="collective-status" class="collective-status"></span>
      </div>
    </div>
  </section>
</div>

<div class="scrollable-content">
  <section class="table-wrapper">
    {% if grouped %}
      <!-- Gruppierte Ansicht -->
      {% for group in grouped_data %}
      <div class="customer-group">
        <div class="customer-header" onclick="this.parentElement.classList.toggle('collapsed')">
          <div class="customer-info">
            <h3>{{ group.customer_name }}</h3>
            <p class="customer-address">{{ group.customer_address }}</p>
          </div>
          <div class="customer-summary">
            <span class="invoice-count">{{ group.invoice_count }} Rechnung(en)</span>
            <span class="group-total">{{ "%.2f"|format(group.total_amount) }} ‚Ç¨</span>
            <span class="toggle-icon">‚ñº</span>
          </div>
        </div>
        <div class="customer-invoices">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Datum</th>
                <th>Rechnungsnr.</th>
                <th>Betrag</th>
                <th>Status</th>
                <th>PDF</th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in group.invoices %}
              <tr class="{% if invoice.status == 'paid' %}paid-invoice{% endif %}">
                <td class="row-number">{{ loop.index }}</td>
                <td>{{ invoice.invoice_date|german_date }}</td>
                <td>{{ invoice.invoice_number or "‚Äì" }}</td>
                <td class="amount">{{ "%.2f"|format(invoice.amount_eur) }} ‚Ç¨</td>
                <td>
                  {% if invoice.status == 'paid' %}
                    <span class="status-badge paid">‚úì Bezahlt ({{ invoice.last_seen_snapshot|german_month }})</span>
                  {% else %}
                    <span class="status-badge open">‚ö† Offen</span>
                  {% endif %}
                </td>
                <td>
                  {% if invoice.file_path %}
                  <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}" target="_blank" rel="noopener">
                    √ñffnen
                  </a>
                  {% else %}
                  ‚Äì
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <p class="empty">Keine passenden Rechnungen gefunden.</p>
      {% endfor %}
    {% else %}
      <!-- Normale Ansicht -->
      <table id="invoice-table">
        <thead>
          <tr>
            <th>#</th>
            {% set is_date_sorted = sort_by == 'date' %}
            {% set date_next_dir = 'desc' if is_date_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_date_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort='date', direction=date_next_dir) }}">
                Datum <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_name_sorted = sort_by == 'name' %}
            {% set name_next_dir = 'desc' if is_name_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_name_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort='name', direction=name_next_dir) }}">
                Empf√§nger <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_address_sorted = sort_by == 'address' %}
            {% set address_next_dir = 'desc' if is_address_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_address_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort='address', direction=address_next_dir) }}">
                Adresse <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_number_sorted = sort_by == 'number' %}
            {% set number_next_dir = 'desc' if is_number_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_number_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort='number', direction=number_next_dir) }}">
                Rechnungsnr. <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_amount_sorted = sort_by == 'amount' %}
            {% set amount_next_dir = 'desc' if is_amount_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_amount_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort='amount', direction=amount_next_dir) }}">
                Betrag <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_status_sorted = sort_by == 'status' %}
            {% set status_next_dir = 'desc' if is_status_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_status_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, invoice_date=invoice_date_filter, grouped='true' if grouped else 'false', sort='status', direction=status_next_dir) }}">
                Status <span class="sort-arrow"></span>
              </a>
            </th>
            <th>SR</th>
            <th>History</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="{% if invoice.status == 'paid' %}paid-invoice{% endif %}">
            <td class="row-number">{{ loop.index }}</td>
            <td data-value="{{ invoice.invoice_date }}">{{ invoice.invoice_date|german_date }}</td>
            <td data-value="{{ invoice.customer_name }}">{{ invoice.customer_name }}</td>
            <td data-value="{{ invoice.customer_address }}">{{ invoice.customer_address }}</td>
            <td data-value="{{ invoice.invoice_number or '' }}">{{ invoice.invoice_number or "‚Äì" }}</td>
            <td class="amount" data-value="{{ invoice.amount_eur }}">{{ "%.2f"|format(invoice.amount_eur) }} ‚Ç¨</td>
            <td data-value="{{ invoice.status }}">
              {% if invoice.status == 'paid' %}
                <span class="status-badge paid">‚úì Bezahlt ({{ invoice.last_seen_snapshot|german_month }})</span>
              {% else %}
                <span class="status-badge open">‚ö† Offen</span>
              {% endif %}
            </td>
            <td style="text-align: center;">
              {% if invoice.in_collective_invoice %}
                <span style="color: green; font-size: 1.2em;">‚úì</span>
              {% else %}
                ‚Äì
              {% endif %}
            </td>
            <td style="text-align: center;">
              <button class="history-btn" data-invoice-id="{{ invoice.id }}" data-invoice-number="{{ invoice.invoice_number or 'N/A' }}" data-customer-name="{{ invoice.customer_name }}" title="Verlauf anzeigen">
                üìã
              </button>
            </td>
            <td>
              {% if invoice.file_path %}
              <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}" target="_blank" rel="noopener">
                √ñffnen
              </a>
              {% else %}
              ‚Äì
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="empty">Keine passenden Rechnungen gefunden.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </section>

  <script>
    // Filter state - initialized with current filter values
    const filterState = {
      invoice_date: '{{ invoice_date_filter }}',
      status: '{{ status_filter }}',
      email: '{{ email_filter }}',
      uncollectible: '{{ uncollectible_filter }}'
    };

    // Default filter values
    const defaultFilters = {
      invoice_date: 'all',
      status: 'open',
      email: 'all',
      uncollectible: 'hide'
    };

    // Filter Modal Toggle
    function toggleFilterModal() {
      const modal = document.getElementById('filterModal');
      modal.classList.toggle('show');
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('filterModal');
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // Handle filter button clicks
    document.querySelectorAll('#filterModal .filter-btn[data-filter]').forEach(btn => {
      btn.addEventListener('click', function() {
        const filterType = this.dataset.filter;
        const filterValue = this.dataset.value;

        // Update state
        filterState[filterType] = filterValue;

        // Update active class for this filter group
        const siblingBtns = this.closest('.filter-buttons').querySelectorAll('.filter-btn');
        siblingBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Apply filters and navigate
    function applyFilters() {
      const params = new URLSearchParams(window.location.search);

      // Update filter params
      params.set('invoice_date', filterState.invoice_date);
      params.set('status', filterState.status);
      params.set('email', filterState.email);
      params.set('uncollectible', filterState.uncollectible);

      // Navigate to new URL
      window.location.href = '{{ url_for("index") }}?' + params.toString();
    }

    // Reset filters to defaults
    function resetFilters() {
      // Reset state to defaults
      Object.assign(filterState, defaultFilters);

      // Update button states visually
      document.querySelectorAll('#filterModal .filter-btn[data-filter]').forEach(btn => {
        const filterType = btn.dataset.filter;
        const filterValue = btn.dataset.value;

        if (defaultFilters[filterType] === filterValue) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Convert MM.JJJJ to YYYY-MM before form submission
    document.querySelector('.date-range-form-inline').addEventListener('submit', function(e) {
      e.preventDefault();

      const fromInput = document.getElementById('from_month');
      const toInput = document.getElementById('to_month');

      // Convert MM.JJJJ to YYYY-MM
      function convertToYYYYMM(value) {
        if (!value) return '';
        const match = value.match(/^(\d{2})\.(\d{4})$/);
        if (match) {
          return match[2] + '-' + match[1]; // YYYY-MM
        }
        return '';
      }

      const fromMonth = convertToYYYYMM(fromInput.value);
      const toMonth = convertToYYYYMM(toInput.value);

      // Create hidden inputs with converted values
      if (fromMonth) {
        const hiddenFrom = document.createElement('input');
        hiddenFrom.type = 'hidden';
        hiddenFrom.name = 'from_month';
        hiddenFrom.value = fromMonth;
        this.appendChild(hiddenFrom);
      }

      if (toMonth) {
        const hiddenTo = document.createElement('input');
        hiddenTo.type = 'hidden';
        hiddenTo.name = 'to_month';
        hiddenTo.value = toMonth;
        this.appendChild(hiddenTo);
      }

      // Submit the form
      this.submit();
    });

    // Print button handler
    document.getElementById('print-button').addEventListener('click', async function() {
      const button = this;
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);

      // Build API URL with current filter parameters
      const apiUrl = new URL('/api/print-invoices', window.location.origin);
      apiUrl.search = params.toString();

      button.disabled = true;
      button.textContent = '‚è≥ Erstelle PDF...';

      try {
        const response = await fetch(apiUrl);

        if (!response.ok) {
          const error = await response.json();
          alert('Fehler beim Erstellen des PDFs: ' + (error.error || 'Unbekannter Fehler'));
          return;
        }

        // Open PDF in new window for printing
        const blob = await response.blob();
        const pdfUrl = URL.createObjectURL(blob);

        // Create a link and trigger download/open
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.target = '_blank';
        link.download = 'rechnungen_druck.pdf';

        // Try to open in new window
        const printWindow = window.open(pdfUrl, '_blank');

        if (printWindow) {
          // Wait a bit for PDF to load, then trigger print
          setTimeout(() => {
            try {
              printWindow.print();
            } catch (e) {
              console.error('Print failed:', e);
            }
          }, 1000);
        } else {
          // Fallback: just download the PDF
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          alert('PDF wird heruntergeladen. Bitte √∂ffnen Sie es manuell zum Drucken.');
        }
      } catch (error) {
        alert('Fehler: ' + error.message);
      } finally {
        button.disabled = false;
        button.textContent = 'üñ® Rechnungen drucken ({{ invoices|length }})';
      }
    });

    // Email button handler with progress modal
    document.getElementById('email-button').addEventListener('click', async function() {
      const invoiceCount = {{ invoices|length }};
      if (!confirm(`M√∂chten Sie wirklich ${invoiceCount} Rechnung(en) per E-Mail versenden?`)) {
        return;
      }

      // Get modal elements
      const modal = document.getElementById('email-progress-modal');
      const summaryText = document.getElementById('email-summary-text');
      const spinner = document.getElementById('email-spinner');
      const progressBar = document.getElementById('email-progress-fill');
      const progressText = document.getElementById('email-progress-text');
      const progressLog = document.getElementById('email-progress-log');
      const closeBtn = document.getElementById('close-email-modal');

      // Open modal
      modal.classList.add('show');
      closeBtn.disabled = true;

      // Reset modal content
      summaryText.textContent = 'Bereite E-Mail-Versand vor...';
      spinner.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      progressLog.innerHTML = '';

      // Build API URL with current filter parameters
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);
      const apiUrl = new URL('/api/send-invoices-email-stream', window.location.origin);
      apiUrl.search = params.toString();

      // Create EventSource for server-sent events
      const eventSource = new EventSource(apiUrl);
      let totalGroups = 0;
      let totalInvoices = 0;

      // Helper function to add log entry
      function addLogEntry(type, message) {
        const entry = document.createElement('div');
        entry.className = `progress-log-entry ${type}`;

        let icon = '‚óè';
        if (type === 'success') icon = '‚úì';
        if (type === 'error') icon = '‚úó';
        if (type === 'info') icon = '‚Üí';

        entry.innerHTML = `
          <span class="log-icon">${icon}</span>
          <span class="log-message">${message}</span>
        `;
        progressLog.appendChild(entry);
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        switch(data.type) {
          case 'summary':
            totalGroups = data.total_groups;
            totalInvoices = data.total_invoices;
            summaryText.textContent = `Versende ${totalInvoices} Rechnung(en) an ${totalGroups} Empf√§nger`;
            addLogEntry('info', `Start: ${totalInvoices} Rechnung(en) an ${totalGroups} Empf√§nger`);
            break;

          case 'status':
            // Update the main status line (summaryText)
            summaryText.textContent = data.message;
            break;

          case 'info':
            addLogEntry('info', `Sende an ${data.email} (${data.count} Rechnung(en))...`);
            break;

          case 'success':
            addLogEntry('success', `‚úì Erfolgreich an ${data.email} versendet (${data.count} Rechnung(en))`);
            break;

          case 'error':
            const errorMsg = data.customer
              ? `‚úó Fehler bei ${data.customer}: ${data.message}`
              : `‚úó Fehler: ${data.message}`;
            addLogEntry('error', errorMsg);
            break;

          case 'progress':
            progressBar.style.width = data.progress + '%';
            progressText.textContent = data.progress + '%';
            break;

          case 'complete':
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            spinner.classList.add('hidden');
            const completionMsg = `Abgeschlossen: ${data.success} erfolgreich versendet${data.failed > 0 ? `, ${data.failed} fehlgeschlagen` : ''}`;
            addLogEntry('info', completionMsg);
            summaryText.textContent = completionMsg;
            closeBtn.disabled = false;
            eventSource.close();
            break;
        }
      };

      eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        spinner.classList.add('hidden');
        addLogEntry('error', 'Verbindungsfehler beim E-Mail-Versand');
        closeBtn.disabled = false;
        eventSource.close();
      };

      // Close button handler
      closeBtn.onclick = function() {
        modal.classList.remove('show');
        eventSource.close();
        window.location.reload(); // Reload to show updated status
      };
    });

    // Collective invoices button handler
    document.getElementById('collective-button').addEventListener('click', async function() {
      // Ask if SEPA mandate should be included
      const includeSepa = confirm('Soll ein SEPA-Lastschriftmandat beigef√ºgt werden?\n\n(Wird automatisch √ºbersprungen f√ºr Kunden mit aktiviertem Bankeinzug)');

      // Ask if email consent form should be included
      const includeEmailConsent = confirm('Soll ein Einwilligungsformular f√ºr E-Mail-Rechnungsversand beigef√ºgt werden?\n\n(Kundenname wird automatisch eingetragen)');

      if (!confirm('M√∂chten Sie wirklich Sammelrechnungen f√ºr alle Rechnungsempf√§nger erzeugen?')) {
        return;
      }

      const button = this;
      const status = document.getElementById('collective-status');

      button.disabled = true;
      button.textContent = '‚è≥ Erstelle Sammelrechnungen...';
      status.textContent = '';
      status.className = 'collective-status';

      try {
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);

        // Add include_sepa parameter
        params.set('include_sepa', includeSepa ? 'true' : 'false');
        // Add include_email_consent parameter
        params.set('include_email_consent', includeEmailConsent ? 'true' : 'false');

        const apiUrl = new URL('/api/generate-collective-invoices', window.location.origin);
        apiUrl.search = params.toString();

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          // Show success modal with statistics
          const modal = document.getElementById('collective-result-modal');
          document.getElementById('collective-count').textContent = data.count;
          document.getElementById('collective-total-invoices').textContent = data.total_invoices;
          document.getElementById('collective-folder').textContent = data.output_folder;

          // Store folder path for opening
          const openFolderBtn = document.getElementById('open-folder-btn');
          openFolderBtn.dataset.folderPath = data.output_folder_absolute;

          modal.classList.add('show');

          status.textContent = `‚úì ${data.count} Sammelrechnung(en) erfolgreich erstellt`;
          status.className = 'collective-status success';
        } else {
          status.textContent = '‚úó Fehler: ' + (data.error || 'Unbekannter Fehler');
          status.className = 'collective-status error';
        }
      } catch (error) {
        status.textContent = '‚úó Netzwerkfehler: ' + error.message;
        status.className = 'collective-status error';
      } finally {
        button.disabled = false;
        button.textContent = 'üìÑ Sammelrechnungen erzeugen';
      }
    });

    // Wait for DOM to be fully loaded before attaching event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Close collective modal handler
      const closeBtn = document.getElementById('close-collective-modal');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          console.log('Schlie√üen-Button geklickt');
          document.getElementById('collective-result-modal').classList.remove('show');
        });
      }

      // Open folder button handler
      const openFolderBtn = document.getElementById('open-folder-btn');
      if (openFolderBtn) {
        openFolderBtn.addEventListener('click', async function() {
          console.log('Ordner √∂ffnen-Button geklickt');
          const folderPath = this.dataset.folderPath;
          console.log('Ordnerpfad:', folderPath);

          if (folderPath) {
            try {
              const response = await fetch('/api/open-folder', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ folder_path: folderPath })
              });

              const data = await response.json();

              if (data.success) {
                console.log('Ordner erfolgreich ge√∂ffnet');
              } else {
                console.error('Fehler beim √ñffnen:', data.error);
                alert('Fehler beim √ñffnen des Ordners: ' + data.error);
              }
            } catch (error) {
              console.error('Netzwerkfehler:', error);
              alert('Netzwerkfehler: ' + error.message);
            }
          } else {
            console.error('Kein Ordnerpfad vorhanden');
            alert('Kein Ordnerpfad vorhanden');
          }
        });
      }

    });

    document.getElementById('scan-button').addEventListener('click', function() {
      const modal = document.getElementById('scan-progress-modal');
      const progressBar = document.getElementById('scan-progress-fill');
      const progressText = document.getElementById('scan-progress-text');
      const progressLog = document.getElementById('scan-progress-log');
      const closeBtn = document.getElementById('close-scan-modal');
      const summaryDiv = document.getElementById('scan-summary');

      // Show modal
      modal.style.display = 'block';
      closeBtn.disabled = true;
      progressLog.innerHTML = '';
      summaryDiv.innerHTML = '<p>Starte Scan...</p>';

      // Create EventSource for Server-Sent Events
      const eventSource = new EventSource('/api/scan-stream');

      let totalFiles = 0;
      let processedFiles = 0;
      let successCount = 0;
      let skippedCount = 0;
      let errorCount = 0;
      const errors = [];

      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'summary') {
          totalFiles = data.total;
          summaryDiv.innerHTML = `<p>Scanne ${totalFiles} PDF-Dateien...</p>`;
        } else if (data.type === 'progress') {
          processedFiles = data.processed;
          const progress = data.progress;
          progressBar.style.width = progress + '%';
          progressText.textContent = `${progress}% (${processedFiles}/${totalFiles})`;
        } else if (data.type === 'success') {
          successCount++;
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry log-success';
          logEntry.textContent = `‚úì ${data.file}`;
          progressLog.appendChild(logEntry);
          progressLog.scrollTop = progressLog.scrollHeight;
        } else if (data.type === 'skipped') {
          skippedCount++;
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry log-info';
          logEntry.textContent = `‚Ü∑ ${data.file} (bereits vorhanden)`;
          progressLog.appendChild(logEntry);
          progressLog.scrollTop = progressLog.scrollHeight;
        } else if (data.type === 'error') {
          if (data.file) {
            errorCount++;
            errors.push(`${data.file}: ${data.message}`);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-error';
            logEntry.textContent = `‚úó ${data.file}: ${data.message}`;
            progressLog.appendChild(logEntry);
            progressLog.scrollTop = progressLog.scrollHeight;
          } else {
            summaryDiv.innerHTML = `<p class="error">Fehler: ${data.message}</p>`;
            eventSource.close();
            closeBtn.disabled = false;
          }
        } else if (data.type === 'complete') {
          eventSource.close();
          progressBar.style.width = '100%';
          progressText.textContent = '100%';

          let summaryHTML = '<div class="scan-complete-summary">';
          summaryHTML += `<p><strong>Scan abgeschlossen!</strong></p>`;
          summaryHTML += `<p>‚úì Neu importiert: ${data.success}</p>`;
          summaryHTML += `<p>‚Ü∑ √úbersprungen: ${data.skipped}</p>`;

          if (data.failed > 0) {
            summaryHTML += `<p>‚úó Fehler: ${data.failed}</p>`;
            summaryHTML += '<details><summary>Fehlerdetails anzeigen</summary><div class="error-details">';
            data.errors.forEach(err => {
              summaryHTML += `<div>${err}</div>`;
            });
            summaryHTML += '</div></details>';
          }

          summaryHTML += '</div>';
          summaryDiv.innerHTML = summaryHTML;
          closeBtn.disabled = false;

          // Check for pending imports after scan completes
          eventSource.close();
          fetch('/api/pending-imports')
            .then(response => response.json())
            .then(pendingData => {
              if (pendingData.success && pendingData.count > 0) {
                // Close scan modal and show pending imports modal
                modal.style.display = 'none';
                setTimeout(() => {
                  if (window.showPendingImportsModal) {
                    window.showPendingImportsModal();
                  }
                }, 300);
              } else if (data.success > 0 || data.skipped > 0) {
                // Reload page after 2 seconds if invoices were imported/skipped
                setTimeout(() => window.location.reload(), 2000);
              }
            })
            .catch(error => {
              console.error('Error checking pending imports:', error);
              // Fallback: just reload if new invoices
              if (data.success > 0) {
                setTimeout(() => window.location.reload(), 2000);
              }
            });
        }
      };

      eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        summaryDiv.innerHTML = '<p class="error">Verbindungsfehler beim Scannen</p>';
        eventSource.close();
        closeBtn.disabled = false;
      };

      // Close button handler
      closeBtn.onclick = function() {
        eventSource.close();
        modal.style.display = 'none';

        // Check for pending imports when closing manually
        fetch('/api/pending-imports')
          .then(response => response.json())
          .then(pendingData => {
            if (pendingData.success && pendingData.count > 0) {
              setTimeout(() => {
                if (window.showPendingImportsModal) {
                  window.showPendingImportsModal();
                }
              }, 300);
            } else if (successCount > 0) {
              window.location.reload();
            }
          })
          .catch(error => {
            console.error('Error checking pending imports:', error);
            if (successCount > 0) {
              window.location.reload();
            }
          });
      };
    });
  </script>

  <!-- Scan Progress Modal -->
  <div id="scan-progress-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Rechnungen scannen</h2>
      </div>
      <div class="modal-body">
        <div id="scan-summary" class="scan-summary"></div>
        <div id="scan-progress-container" class="progress-container">
          <div id="scan-progress-bar" class="progress-bar">
            <div id="scan-progress-fill" class="progress-fill"></div>
          </div>
          <div id="scan-progress-text" class="progress-text">0%</div>
        </div>
        <div id="scan-progress-log" class="progress-log"></div>
      </div>
      <div class="modal-footer">
        <button id="close-scan-modal" class="modal-close-btn" disabled>Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Email Progress Modal -->
  <div id="email-progress-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>E-Mail Versand</h2>
      </div>
      <div class="modal-body">
        <div id="email-summary" class="email-summary">
          <div id="email-spinner" class="status-spinner"></div>
          <span id="email-summary-text"></span>
        </div>
        <div id="email-progress-container" class="progress-container">
          <div id="email-progress-bar" class="progress-bar">
            <div id="email-progress-fill" class="progress-fill"></div>
          </div>
          <div id="email-progress-text" class="progress-text">0%</div>
        </div>
        <div id="email-progress-log" class="progress-log"></div>
      </div>
      <div class="modal-footer">
        <button id="close-email-modal" class="modal-close-btn" disabled>Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Collective Invoices Result Modal -->
  <div id="collective-result-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sammelrechnungen erstellt</h2>
      </div>
      <div class="modal-body">
        <div id="collective-summary" class="collective-summary">
          <div class="stat-row">
            <span class="stat-label">Anzahl Sammelrechnungen:</span>
            <span class="stat-value" id="collective-count">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Enthaltene Einzelrechnungen:</span>
            <span class="stat-value" id="collective-total-invoices">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Gespeichert in:</span>
            <span class="stat-value" id="collective-folder">-</span>
          </div>
        </div>
        <div id="collective-open-folder" class="folder-link-container">
          <button id="open-folder-btn" class="open-folder-btn">üìÅ Ordner √∂ffnen</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="close-collective-modal" class="modal-close-btn">Schlie√üen</button>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="history-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>Rechnungs-Verlauf</h2>
    </div>
    <div class="modal-body" style="padding: 2rem;">
      <div id="history-invoice-info" style="margin-bottom: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">
          <strong>Kunde:</strong>
          <span id="history-customer-name">-</span>
          <strong>Rechnungsnr.:</strong>
          <span id="history-invoice-number">-</span>
          <strong>Datum:</strong>
          <span id="history-invoice-date">-</span>
          <strong>Betrag:</strong>
          <span id="history-invoice-amount">-</span>
        </div>
      </div>
      <div id="history-loading" style="text-align: center; padding: 2rem;">
        Lade Verlauf...
      </div>
      <div id="history-timeline" style="max-height: 400px; overflow-y: auto;">
      </div>
    </div>
    <div class="modal-footer">
      <button id="close-history-modal" class="modal-close-btn">Schlie√üen</button>
    </div>
  </div>
</div>

<script>
  // History Modal Logic
  (function() {
    const modal = document.getElementById('history-modal');
    const closeBtn = document.getElementById('close-history-modal');
    const historyBtns = document.querySelectorAll('.history-btn');

    // Event type translations
    const eventTypeTranslations = {
      'IMPORT': 'Import',
      'EMAIL_SENT': 'E-Mail versendet',
      'COLLECTIVE_INVOICE_CREATED': 'Sammelrechnung erstellt',
      'COLLECTIVE_INVOICE_SENT': 'Sammelrechnung versendet',
      'REMINDER_CREATED': 'Mahnung erstellt',
      'REMINDER_SENT': 'Mahnung versendet',
      'MARKED_UNCOLLECTIBLE': 'Als uneinbringbar markiert',
      'UNMARKED_UNCOLLECTIBLE': 'Uneinbringbar-Status aufgehoben'
    };

    // Event type icons
    const eventTypeIcons = {
      'IMPORT': 'üì•',
      'EMAIL_SENT': '‚úâÔ∏è',
      'COLLECTIVE_INVOICE_CREATED': 'üìÑ',
      'COLLECTIVE_INVOICE_SENT': 'üìÆ',
      'REMINDER_CREATED': '‚ö†Ô∏è',
      'REMINDER_SENT': 'üì®',
      'MARKED_UNCOLLECTIBLE': '‚ùå',
      'UNMARKED_UNCOLLECTIBLE': '‚úÖ'
    };

    // Reminder level translations
    const reminderLevelTranslations = {
      0: 'Zahlungserinnerung',
      1: '1. Mahnung',
      2: '2. Mahnung'
    };

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatEventDetails(eventType, metadata) {
      const details = [];

      if (metadata.email) {
        details.push(`E-Mail: ${metadata.email}`);
      }

      if (metadata.letterxpress_job_id) {
        details.push(`LetterXpress Job: #${metadata.letterxpress_job_id}`);
      }

      if (metadata.price !== undefined) {
        details.push(`Kosten: ${metadata.price.toFixed(2)} ‚Ç¨`);
      }

      if (metadata.reminder_level !== undefined) {
        details.push(`Stufe: ${reminderLevelTranslations[metadata.reminder_level] || metadata.reminder_level}`);
      }

      if (metadata.filename) {
        details.push(`Datei: ${metadata.filename}`);
      }

      if (metadata.mode) {
        details.push(`Modus: ${metadata.mode}`);
      }

      return details.length > 0 ? details.join(' ‚Ä¢ ') : '';
    }

    function loadHistory(invoiceId, customerName, invoiceNumber) {
      // Show modal
      modal.classList.add('show');

      // Reset content
      document.getElementById('history-loading').style.display = 'block';
      document.getElementById('history-loading').textContent = 'Lade Verlauf...';
      document.getElementById('history-timeline').innerHTML = '';

      // Fetch history
      fetch(`/api/invoices/${invoiceId}/history`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update invoice info
            document.getElementById('history-customer-name').textContent = data.invoice.customer_name;
            document.getElementById('history-invoice-number').textContent = data.invoice.invoice_number || 'N/A';
            document.getElementById('history-invoice-date').textContent = formatTimestamp(data.invoice.invoice_date);
            document.getElementById('history-invoice-amount').textContent = `${data.invoice.amount_eur.toFixed(2)} ‚Ç¨`;

            // Build timeline
            const timeline = document.getElementById('history-timeline');
            timeline.innerHTML = '';

            if (data.events.length === 0) {
              timeline.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Noch keine Ereignisse f√ºr diese Rechnung.</div>';
            } else {
              const timelineList = document.createElement('div');
              timelineList.style.cssText = 'position: relative; padding-left: 2rem;';

              data.events.forEach((event, index) => {
                const eventItem = document.createElement('div');
                eventItem.style.cssText = 'position: relative; padding-bottom: 1.5rem;';

                // Timeline line
                if (index < data.events.length - 1) {
                  const line = document.createElement('div');
                  line.style.cssText = 'position: absolute; left: -1.4rem; top: 1.5rem; bottom: 0; width: 2px; background: #ddd;';
                  eventItem.appendChild(line);
                }

                // Timeline dot
                const dot = document.createElement('div');
                dot.style.cssText = 'position: absolute; left: -1.8rem; top: 0.3rem; width: 1rem; height: 1rem; border-radius: 50%; background: #4CAF50; border: 3px solid white; box-shadow: 0 0 0 1px #ddd;';
                eventItem.appendChild(dot);

                // Event content
                const content = document.createElement('div');
                const icon = eventTypeIcons[event.event_type] || '‚Ä¢';
                const eventName = eventTypeTranslations[event.event_type] || event.event_type;
                const details = formatEventDetails(event.event_type, event.metadata);

                content.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 0.25rem;">
                    ${icon} ${eventName}
                  </div>
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                    ${formatTimestamp(event.timestamp)}
                  </div>
                  ${details ? `<div style="font-size: 0.85rem; color: #444;">${details}</div>` : ''}
                `;
                eventItem.appendChild(content);

                timelineList.appendChild(eventItem);
              });

              timeline.appendChild(timelineList);
            }

            // Hide loading
            document.getElementById('history-loading').style.display = 'none';
          } else {
            document.getElementById('history-timeline').innerHTML = `<div style="text-align: center; padding: 2rem; color: #d32f2f;">Fehler: ${data.error}</div>`;
          }
        })
        .catch(error => {
          console.error('Error loading history:', error);
          document.getElementById('history-timeline').innerHTML = `<div style="text-align: center; padding: 2rem; color: #d32f2f;">Fehler beim Laden des Verlaufs.</div>`;
        });
    }

    // Attach click handlers to all history buttons
    historyBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const invoiceId = this.getAttribute('data-invoice-id');
        const customerName = this.getAttribute('data-customer-name');
        const invoiceNumber = this.getAttribute('data-invoice-number');
        loadHistory(invoiceId, customerName, invoiceNumber);
      });
    });

    // Close modal handler
    closeBtn.addEventListener('click', function() {
      modal.classList.remove('show');
    });

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });
  })();

  // Pending Imports Modal
  (function() {
    let currentImports = [];
    let currentIndex = 0;

    function showPendingImportsModal() {
      // Get elements when function is called (modal HTML should be loaded by now)
      const modal = document.getElementById('pending-imports-modal');
      const importsList = document.getElementById('pending-imports-list');
      const pendingCount = document.getElementById('pending-imports-count');

      if (!modal || !importsList || !pendingCount) {
        console.error('Pending imports modal elements not found');
        return;
      }

      // Fetch pending imports
      fetch('/api/pending-imports')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.count > 0) {
            currentImports = data.pending_imports;
            currentIndex = 0;
            pendingCount.textContent = data.count;
            renderCurrentImport();
            updateNavigationButtons();
            modal.classList.add('show');
          }
        })
        .catch(error => {
          console.error('Error fetching pending imports:', error);
        });
    }

    function renderCurrentImport() {
      const importsList = document.getElementById('pending-imports-list');
      const currentIndexEl = document.getElementById('pending-current-index');

      if (!currentImports || currentImports.length === 0) return;

      const imp = currentImports[currentIndex];
      currentIndexEl.textContent = currentIndex + 1;

      importsList.innerHTML = '';
      const importDiv = document.createElement('div');
      importDiv.className = 'pending-import-item';
      importDiv.innerHTML = `
        <div class="pending-import-header">
          <div>
            <strong>Neue Rechnung:</strong> ${imp.invoice_number || 'ohne Nummer'} ¬∑ ${imp.invoice_date}
          </div>
          <span class="pending-import-amount">${(imp.amount_euros).toFixed(2)} ‚Ç¨</span>
        </div>

        <div class="similar-customers-section">
          ${imp.similar_customers.map((customer, idx) => `
            <div class="similar-customer-group">
              <div class="comparison-header">
                <span class="similarity-score">${customer.similarity_score}% √§hnlich</span>
                <span style="color: #666; font-size: 0.85rem;">${customer.invoice_count} Rechnung(en) vorhanden</span>
              </div>

              <div class="comparison-container">
                <div class="comparison-column comparison-new">
                  <div class="comparison-label">üìÑ Neue Rechnung</div>
                  <div class="comparison-name">${customer.new_name_highlighted || imp.customer_name}</div>
                  <div class="comparison-address">${customer.new_street_highlighted || imp.customer_street}</div>
                  <div class="comparison-address">${customer.new_city_highlighted || imp.customer_city}</div>
                </div>

                <div class="comparison-divider">‚Üî</div>

                <div class="comparison-column comparison-existing">
                  <div class="comparison-label">üíæ In Datenbank</div>
                  <div class="comparison-name">${customer.customer_name_highlighted || customer.customer_name}</div>
                  <div class="comparison-address">${customer.customer_street_highlighted || customer.customer_street}</div>
                  <div class="comparison-address">${customer.customer_city_highlighted || customer.customer_city}</div>
                </div>
              </div>

              <div class="comparison-options">
                <div class="similar-customer-option">
                  <input type="radio"
                         id="customer-${imp.id}-${idx}-new"
                         name="customer-${imp.id}"
                         value="${idx}-new"
                         ${idx === 0 ? 'checked' : ''}>
                  <label for="customer-${imp.id}-${idx}-new">
                    <strong>üìÑ Neue Version verwenden</strong>
                    <span style="font-size: 0.85em; color: #666; display: block; margin-top: 0.15rem;">
                      (${customer.invoice_count} bestehende Rechnung(en) aktualisieren)
                    </span>
                  </label>
                </div>
                <div class="similar-customer-option">
                  <input type="radio"
                         id="customer-${imp.id}-${idx}-old"
                         name="customer-${imp.id}"
                         value="${idx}-old">
                  <label for="customer-${imp.id}-${idx}-old">
                    <strong>üíæ Datenbank-Version verwenden</strong>
                    <span style="font-size: 0.85em; color: #666; display: block; margin-top: 0.15rem;">
                      (Bestehende Daten behalten)
                    </span>
                  </label>
                </div>
              </div>
            </div>
          `).join('')}

          <div class="similar-customer-option" style="margin-top: 1rem; border: 2px dashed #ddd;">
            <input type="radio"
                   id="customer-${imp.id}-new"
                   name="customer-${imp.id}"
                   value="new">
            <label for="customer-${imp.id}-new">
              <strong>‚ûï Als komplett neuen Kunden anlegen</strong>
              <span style="font-size: 0.85em; color: #666; display: block; margin-top: 0.15rem;">
                (Nicht zusammenf√ºhren)
              </span>
            </label>
          </div>
        </div>

        <div class="pending-import-actions">
          <button class="btn-resolve" data-import-id="${imp.id}" data-customer-data='${JSON.stringify(imp.similar_customers)}'>
            ‚úì Auswahl best√§tigen
          </button>
        </div>
      `;
      importsList.appendChild(importDiv);

      // Attach resolve handler
      const resolveBtn = importDiv.querySelector('.btn-resolve');
      if (resolveBtn) {
        resolveBtn.addEventListener('click', function() {
          const importId = parseInt(this.getAttribute('data-import-id'));
          const customersData = JSON.parse(this.getAttribute('data-customer-data'));
          const selectedRadio = document.querySelector(`input[name="customer-${importId}"]:checked`);

          if (!selectedRadio) {
            alert('Bitte w√§hlen Sie eine Option aus');
            return;
          }

          const selectedValue = selectedRadio.value;
          let action, selectedCustomer, useNewData = false;

          if (selectedValue === 'new') {
            action = 'create_new';
            selectedCustomer = null;
          } else if (selectedValue.endsWith('-old')) {
            action = 'merge_with_existing';
            const idx = parseInt(selectedValue.split('-')[0]);
            selectedCustomer = customersData[idx];
            useNewData = false;
          } else if (selectedValue.endsWith('-new')) {
            action = 'merge_with_existing';
            const idx = parseInt(selectedValue.split('-')[0]);
            selectedCustomer = customersData[idx];
            useNewData = true;
          }

          resolveImport(importId, action, selectedCustomer, useNewData);
        });
      }
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('pending-prev-btn');
      const nextBtn = document.getElementById('pending-next-btn');

      if (prevBtn) {
        prevBtn.disabled = currentIndex === 0;
        prevBtn.style.opacity = currentIndex === 0 ? '0.5' : '1';
      }

      if (nextBtn) {
        nextBtn.disabled = currentIndex >= currentImports.length - 1;
        nextBtn.style.opacity = currentIndex >= currentImports.length - 1 ? '0.5' : '1';
      }
    }

    function navigatePrev() {
      if (currentIndex > 0) {
        currentIndex--;
        renderCurrentImport();
        updateNavigationButtons();
      }
    }

    function navigateNext() {
      if (currentIndex < currentImports.length - 1) {
        currentIndex++;
        renderCurrentImport();
        updateNavigationButtons();
      }
    }

    function resolveImport(importId, action, selectedCustomer, useNewData = false) {
      const modal = document.getElementById('pending-imports-modal');

      fetch('/api/resolve-import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          import_id: importId,
          action: action,
          selected_customer: selectedCustomer,
          use_new_data: useNewData
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove resolved import from array
          currentImports = currentImports.filter(imp => imp.id !== importId);

          if (currentImports.length > 0) {
            // Adjust index if needed
            if (currentIndex >= currentImports.length) {
              currentIndex = currentImports.length - 1;
            }
            // Update count and render
            document.getElementById('pending-imports-count').textContent = currentImports.length;
            renderCurrentImport();
            updateNavigationButtons();
          } else {
            // No more imports, close modal and reload
            if (modal) modal.classList.remove('show');
            window.location.reload();
          }
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      })
      .catch(error => {
        console.error('Error resolving import:', error);
        alert('Fehler beim Aufl√∂sen des Imports');
      });
    }

    // Make function globally accessible
    window.showPendingImportsModal = showPendingImportsModal;

    // Set up event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('pending-imports-modal');
      const closeBtn = document.getElementById('close-pending-imports-modal');
      const prevBtn = document.getElementById('pending-prev-btn');
      const nextBtn = document.getElementById('pending-next-btn');

      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (modal) modal.classList.remove('show');
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', navigatePrev);
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', navigateNext);
      }

      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.remove('show');
          }
        });
      }
    });
  })();

  // Check for pending imports on page load
  (function() {
    const button = document.getElementById('pending-imports-button');
    const badge = document.getElementById('pending-imports-badge');

    function updatePendingImportsBadge() {
      fetch('/api/pending-imports')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.count > 0) {
            if (badge && button) {
              badge.textContent = data.count;
              button.style.display = 'inline-block';
            }
          } else {
            if (button) {
              button.style.display = 'none';
            }
          }
        })
        .catch(error => console.error('Error checking pending imports:', error));
    }

    // Set up click handler
    if (button) {
      button.addEventListener('click', function() {
        if (window.showPendingImportsModal) {
          window.showPendingImportsModal();
        } else {
          console.error('showPendingImportsModal function not found');
        }
      });
    }

    // Update badge on page load
    updatePendingImportsBadge();

    // Update badge every 30 seconds
    setInterval(updatePendingImportsBadge, 30000);
  })();
</script>

<!-- Pending Imports Modal -->
<div id="pending-imports-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>Import √ºberpr√ºfen</h2>
      <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.95rem;">
        Import <span id="pending-current-index">1</span> von <span id="pending-imports-count">0</span>
      </p>
    </div>
    <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
      <div id="pending-imports-list"></div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
      <button id="pending-prev-btn" class="modal-nav-btn">‚Üê Zur√ºck</button>
      <button id="close-pending-imports-modal" class="modal-close-btn">Sp√§ter</button>
      <button id="pending-next-btn" class="modal-nav-btn">Weiter ‚Üí</button>
    </div>
  </div>
</div>

<style>
.pending-import-item {
  background: #fff;
}

.pending-import-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid #f0f0f0;
}

.pending-import-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.15rem;
}

.pending-import-amount {
  font-size: 1.15rem;
  font-weight: bold;
  color: #4CAF50;
}

.pending-import-details {
  margin-bottom: 1rem;
}

.detail-row {
  padding: 0.35rem 0;
  color: #555;
  font-size: 0.9rem;
}

.similar-customers-section {
  margin-top: 1rem;
}

.similar-customers-section h4 {
  margin-bottom: 0.75rem;
  color: #333;
}

.similar-customer-group {
  margin-bottom: 1rem;
  padding: 1rem;
  border: 2px solid #ddd;
  border-radius: 6px;
  background: #fafafa;
}

.comparison-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.comparison-container {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  padding: 1rem;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.comparison-column {
  flex: 1;
  min-width: 0;
}

.comparison-new {
  border-right: 2px solid #e0e0e0;
  padding-right: 1rem;
}

.comparison-existing {
  padding-left: 1rem;
}

.comparison-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.comparison-name {
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.35rem;
}

.comparison-address {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0.2rem;
}

.comparison-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: #999;
  padding: 0 0.5rem;
  min-width: 2rem;
}

.comparison-options {
  display: flex;
  gap: 0.75rem;
}

.comparison-options .similar-customer-option {
  flex: 1;
  margin-bottom: 0;
}

.customer-group-header {
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.customer-group-header strong {
  font-size: 1rem;
  color: #333;
  display: block;
  margin-bottom: 0.15rem;
}

.customer-group-header .customer-address,
.customer-group-header .customer-meta {
  font-size: 0.85rem;
  margin: 0.15rem 0;
}

.similar-customer-option {
  display: flex;
  align-items: flex-start;
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  border: 2px solid #e0e0e0;
  border-radius: 4px;
  background: white;
  transition: all 0.2s;
}

.similar-customer-option:last-child {
  margin-bottom: 0;
}

.similar-customer-option:hover {
  background: #f9f9f9;
  border-color: #4CAF50;
}

.similar-customer-option input[type="radio"] {
  margin-right: 1rem;
  margin-top: 0.25rem;
}

.similar-customer-option input[type="radio"]:checked + label {
  color: #4CAF50;
}

.similar-customer-option label {
  flex: 1;
  cursor: pointer;
}

.customer-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.similarity-score {
  background: #4CAF50;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: bold;
}

.customer-address {
  color: #666;
  font-size: 0.95rem;
  margin-bottom: 0.25rem;
}

.customer-meta {
  color: #999;
  font-size: 0.85rem;
}

.pending-import-actions {
  margin-top: 1rem;
  text-align: center;
}

.btn-resolve {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 0.65rem 1.75rem;
  border-radius: 6px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background 0.2s;
  font-weight: 500;
}

.btn-resolve:hover {
  background: #45a049;
}

.btn-resolve:active {
  background: #3d8b40;
}

/* Diff highlighting */
mark.diff-change {
  background-color: #fff3cd;
  color: #856404;
  padding: 0.1rem 0.2rem;
  border-radius: 2px;
  font-weight: 600;
}

mark.diff-insert {
  background-color: #d4edda;
  color: #155724;
  padding: 0.1rem 0.2rem;
  border-radius: 2px;
  font-weight: 600;
}

mark.diff-delete {
  background-color: #f8d7da;
  color: #721c24;
  padding: 0.1rem 0.2rem;
  border-radius: 2px;
  font-weight: 600;
  text-decoration: line-through;
}

.modal-nav-btn {
  background: #f0f0f0;
  color: #333;
  border: 2px solid #ddd;
  padding: 0.5rem 1.25rem;
  border-radius: 6px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.modal-nav-btn:hover:not(:disabled) {
  background: #e0e0e0;
  border-color: #4CAF50;
}

.modal-nav-btn:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.modal-close-btn {
  background: transparent;
  color: #666;
  border: none;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: color 0.2s;
}

.modal-close-btn:hover {
  color: #333;
  text-decoration: underline;
}
</style>

{% endblock %}
