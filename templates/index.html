{% extends "base.html" %}

{% block title %}Rechnungs√ºbersicht{% endblock %}

{% block content %}
<div class="sticky-header">
  <header>
    <h1>Apotheken-Rechnungen</h1>
    <p class="subtitle">Anzeige der {{ limit }} zuletzt erfassten Rechnungen.</p>
  </header>

  <div class="scan-controls">
    <button id="scan-button" class="scan-button">&#x1F50D; Neu Importieren</button>
    <button id="pending-imports-button" class="scan-button" style="background-color: #ff6b35; margin-left: 0.5rem; display: none;">
      ‚ö†Ô∏è Pending Imports <span id="pending-imports-badge" class="filter-badge"></span>
    </button>
    <form method="get" class="search-form" style="display: inline-flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
      <label for="q">Suche</label>
      <input type="text" id="q" name="q" value="{{ query }}" placeholder="Name, Rechnungsnummer oder Adresse">
      <input type="hidden" name="grouped" value="{{ 'true' if grouped else 'false' }}">
      <input type="hidden" name="sort" value="{{ sort_by }}">
      <input type="hidden" name="direction" value="{{ sort_direction }}">
      <input type="hidden" name="time" value="{{ time_filter }}">
      <input type="hidden" name="status" value="{{ status_filter }}">
      <input type="hidden" name="email" value="{{ email_filter }}">
      <input type="hidden" name="uncollectible" value="{{ uncollectible_filter }}">
      <input type="hidden" name="collective" value="{{ collective_filter }}">
      <input type="hidden" name="invoice_date_from" value="{{ invoice_date_from }}">
      <input type="hidden" name="invoice_date_to" value="{{ invoice_date_to }}">
      <button type="submit">Filtern</button>
      {% if query %}
      <a class="reset" href="{{ url_for('index', time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort=sort_by, direction=sort_direction) }}">Suche zur√ºcksetzen</a>
      {% endif %}
    </form>
    <span id="scan-status" class="scan-status"></span>
    <!-- Filter Button - rechts oben -->
    <button type="button" class="filter-toggle-btn filter-toggle-btn-header" onclick="toggleFilterModal()">
      üîç Filter
      {% if invoice_date_from or invoice_date_to or status_filter != 'open' or email_filter != 'all' or uncollectible_filter != 'hide' or collective_filter != 'all' %}
      <span class="filter-badge">aktiv</span>
      {% endif %}
    </button>
  </div>

  <section class="controls">
    <div class="filter-grid">
      <!-- Snapshot Buttons -->
      <div class="filter-row snapshot-row">
        <label class="filter-label">Snapshot:</label>
        <div class="filter-buttons">
          <a href="{{ url_for('index', q=query, time='all', status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort=sort_by, direction=sort_direction) }}"
             class="filter-btn {% if time_filter == 'all' %}active{% endif %}">
            üìã Alle Monate
          </a>
          <a href="{{ url_for('index', q=query, time='current_month', status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort=sort_by, direction=sort_direction) }}"
             class="filter-btn {% if time_filter == 'current_month' %}active{% endif %}">
            {% if time_filter == 'current_month' and latest_snapshot %}
              üìÖ {{ latest_snapshot.split('-')[1] }}/{{ latest_snapshot.split('-')[0] }}
            {% else %}
              üìÖ Aktueller Monat
            {% endif %}
          </a>
        </div>

        <!-- Custom Date Range immer sichtbar -->
        <form method="get" class="date-range-form-inline">
          <input type="hidden" name="q" value="{{ query }}">
          <input type="hidden" name="time" value="custom">
          <input type="hidden" name="status" value="{{ status_filter }}">
          <input type="hidden" name="email" value="{{ email_filter }}">
          <input type="hidden" name="uncollectible" value="{{ uncollectible_filter }}">
          <input type="hidden" name="collective" value="{{ collective_filter }}">
          <input type="hidden" name="invoice_date_from" value="{{ invoice_date_from }}">
          <input type="hidden" name="invoice_date_to" value="{{ invoice_date_to }}">
          <input type="hidden" name="grouped" value="{{ 'true' if grouped else 'false' }}">
          <input type="hidden" name="sort" value="{{ sort_by }}">
          <input type="hidden" name="direction" value="{{ sort_direction }}">

          <label for="from_month" class="date-label-inline">Von:</label>
          <input type="text" id="from_month" name="from_month_display"
                 value="{% if from_month %}{{ from_month.split('-')[1] }}.{{ from_month.split('-')[0] }}{% elif min_month %}{{ min_month.split('-')[1] }}.{{ min_month.split('-')[0] }}{% endif %}"
                 placeholder="MM.JJJJ"
                 pattern="\d{2}\.\d{4}"
                 class="month-input month-input-text">

          <label for="to_month" class="date-label-inline">Bis:</label>
          <input type="text" id="to_month" name="to_month_display"
                 value="{% if to_month %}{{ to_month.split('-')[1] }}.{{ to_month.split('-')[0] }}{% elif max_month %}{{ max_month.split('-')[1] }}.{{ max_month.split('-')[0] }}{% endif %}"
                 placeholder="MM.JJJJ"
                 pattern="\d{2}\.\d{4}"
                 class="month-input month-input-text">

          <button type="submit" class="apply-btn-inline">Anwenden</button>
        </form>
      </div>

    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="filter-modal">
      <div class="filter-modal-content">
        <div class="filter-modal-header">
          <h3>Filter</h3>
          <span class="filter-modal-close" onclick="toggleFilterModal()">&times;</span>
        </div>
        <div class="filter-modal-body">
          <!-- Rechnungsdatum Filter Date Range -->
          <div class="filter-row">
            <label class="filter-label">Rechnungsdatum:</label>
            <div class="filter-date-range">
              <div class="date-input-wrapper">
                <input type="date" id="invoice_date_from" class="filter-date-input {% if invoice_date_from %}has-value{% endif %}"
                       value="{{ invoice_date_from }}">
                <button type="button" class="date-clear-btn" onclick="clearDateInput('invoice_date_from')" title="Datum l√∂schen" {% if not invoice_date_from %}style="display:none"{% endif %}>&times;</button>
              </div>
              <span class="date-range-separator">bis</span>
              <div class="date-input-wrapper">
                <input type="date" id="invoice_date_to" class="filter-date-input {% if invoice_date_to %}has-value{% endif %}"
                       value="{{ invoice_date_to }}">
                <button type="button" class="date-clear-btn" onclick="clearDateInput('invoice_date_to')" title="Datum l√∂schen" {% if not invoice_date_to %}style="display:none"{% endif %}>&times;</button>
              </div>
            </div>
          </div>

          <!-- Status Buttons -->
          <div class="filter-row">
            <label class="filter-label">Status:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if status_filter == 'all' %}active{% endif %}"
                      data-filter="status" data-value="all">
                üìã Alle
              </button>
              <button type="button" class="filter-btn {% if status_filter == 'open' %}active{% endif %}"
                      data-filter="status" data-value="open">
                ‚ö† Nur Offene
              </button>
              <button type="button" class="filter-btn {% if status_filter == 'paid' %}active{% endif %}"
                      data-filter="status" data-value="paid">
                ‚úì Nur Bezahlte
              </button>
            </div>
          </div>

          <!-- Email Filter Buttons -->
          <div class="filter-row">
            <label class="filter-label">Email:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if email_filter == 'all' %}active{% endif %}"
                      data-filter="email" data-value="all">
                üìã Alle
              </button>
              <button type="button" class="filter-btn {% if email_filter == 'with_email' %}active{% endif %}"
                      data-filter="email" data-value="with_email">
                ‚úâ Mit Email
              </button>
              <button type="button" class="filter-btn {% if email_filter == 'without_email' %}active{% endif %}"
                      data-filter="email" data-value="without_email">
                ‚úó Ohne Email
              </button>
            </div>
          </div>

          <!-- Uncollectible Filter Buttons -->
          <div class="filter-row">
            <label class="filter-label">Uneinbringbar:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if uncollectible_filter == 'hide' %}active{% endif %}"
                      data-filter="uncollectible" data-value="hide">
                üö´ Ausblenden
              </button>
              <button type="button" class="filter-btn {% if uncollectible_filter == 'show' %}active{% endif %}"
                      data-filter="uncollectible" data-value="show">
                üëÅ Anzeigen
              </button>
              <button type="button" class="filter-btn {% if uncollectible_filter == 'only' %}active{% endif %}"
                      data-filter="uncollectible" data-value="only">
                ‚ö†Ô∏è Nur Uneinbringbare
              </button>
            </div>
          </div>

          <!-- Collective Invoice Filter Buttons -->
          <div class="filter-row">
            <label class="filter-label">Sammelrechnung:</label>
            <div class="filter-buttons">
              <button type="button" class="filter-btn {% if collective_filter == 'all' %}active{% endif %}"
                      data-filter="collective" data-value="all">
                üìã Alle
              </button>
              <button type="button" class="filter-btn {% if collective_filter == 'in' %}active{% endif %}"
                      data-filter="collective" data-value="in">
                ‚úì In SR
              </button>
              <button type="button" class="filter-btn {% if collective_filter == 'not_in' %}active{% endif %}"
                      data-filter="collective" data-value="not_in">
                ‚úó Nicht in SR
              </button>
            </div>
          </div>
        </div>
        <div class="filter-modal-footer">
          <button type="button" class="filter-reset-btn" onclick="resetFilters()">Zur√ºcksetzen</button>
          <button type="button" class="filter-apply-btn" onclick="applyFilters()">Anwenden</button>
        </div>
      </div>
    </div>
    <div class="action-buttons-container">
      <div class="action-buttons-grid">
        <button id="print-button" class="print-button action-btn">&#x1F5A8; Rechnungen drucken ({{ invoices|length }})</button>
        <button id="email-button" class="email-button action-btn">&#x2709; Rechnungen per E-Mail versenden ({{ invoices|length }})</button>
        <button id="collective-button" class="collective-button action-btn">&#x1F4C4; Sammelrechnungen erzeugen</button>
        <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='false' if grouped else 'true', sort=sort_by, direction=sort_direction) }}" class="toggle-button action-btn">
          {% if grouped %}
          &#x1F4CB; Normale Ansicht
          {% else %}
          &#x1F465; Nach Empf√§nger gruppieren
          {% endif %}
        </a>
      </div>
      <div class="action-status">
        <span id="email-status" class="email-status"></span>
        <span id="collective-status" class="collective-status"></span>
      </div>
    </div>
  </section>
</div>

<div class="scrollable-content">
  <section class="table-wrapper">
    {% if grouped %}
      <!-- Gruppierte Ansicht -->
      {% for group in grouped_data %}
      <div class="customer-group">
        <div class="customer-header" onclick="this.parentElement.classList.toggle('collapsed')">
          <div class="customer-info">
            <h3>{{ group.customer_name }}</h3>
            <p class="customer-address">{{ group.customer_address }}</p>
          </div>
          <div class="customer-summary">
            <span class="invoice-count">{{ group.invoice_count }} Rechnung(en)</span>
            <span class="group-total">{{ "%.2f"|format(group.total_amount) }} ‚Ç¨</span>
            <span class="toggle-icon">‚ñº</span>
          </div>
        </div>
        <div class="customer-invoices">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Datum</th>
                <th>Rechnungsnr.</th>
                <th>Betrag</th>
                <th>Status</th>
                <th>PDF</th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in group.invoices %}
              <tr class="{% if invoice.status == 'paid' %}paid-invoice{% endif %}">
                <td class="row-number">{{ loop.index }}</td>
                <td>{{ invoice.invoice_date|german_date }}</td>
                <td>{{ invoice.invoice_number or "‚Äì" }}</td>
                <td class="amount">{{ "%.2f"|format(invoice.amount_eur) }} ‚Ç¨</td>
                <td>
                  {% if invoice.status == 'paid' %}
                    <span class="status-badge paid">‚úì Bezahlt ({{ invoice.last_seen_snapshot|german_month }})</span>
                  {% else %}
                    <span class="status-badge open">‚ö† Offen</span>
                  {% endif %}
                </td>
                <td>
                  {% if invoice.file_path %}
                  <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}" target="_blank" rel="noopener">
                    √ñffnen
                  </a>
                  {% else %}
                  ‚Äì
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <p class="empty">Keine passenden Rechnungen gefunden.</p>
      {% endfor %}
    {% else %}
      <!-- Normale Ansicht -->
      <table id="invoice-table">
        <thead>
          <tr>
            <th>#</th>
            {% set is_date_sorted = sort_by == 'date' %}
            {% set date_next_dir = 'desc' if is_date_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_date_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort='date', direction=date_next_dir) }}">
                Datum <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_name_sorted = sort_by == 'name' %}
            {% set name_next_dir = 'desc' if is_name_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_name_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort='name', direction=name_next_dir) }}">
                Empf√§nger <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_address_sorted = sort_by == 'address' %}
            {% set address_next_dir = 'desc' if is_address_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_address_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort='address', direction=address_next_dir) }}">
                Adresse <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_number_sorted = sort_by == 'number' %}
            {% set number_next_dir = 'desc' if is_number_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_number_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort='number', direction=number_next_dir) }}">
                Rechnungsnr. <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_amount_sorted = sort_by == 'amount' %}
            {% set amount_next_dir = 'desc' if is_amount_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_amount_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort='amount', direction=amount_next_dir) }}">
                Betrag <span class="sort-arrow"></span>
              </a>
            </th>
            {% set is_status_sorted = sort_by == 'status' %}
            {% set status_next_dir = 'desc' if is_status_sorted and sort_direction == 'asc' else 'asc' %}
            <th class="sortable {% if is_status_sorted %}sort-{{ sort_direction }}{% endif %}">
              <a href="{{ url_for('index', q=query, limit=limit, time=time_filter, from_month=from_month, to_month=to_month, status=status_filter, email=email_filter, uncollectible=uncollectible_filter, collective=collective_filter, invoice_date_from=invoice_date_from, invoice_date_to=invoice_date_to, grouped='true' if grouped else 'false', sort='status', direction=status_next_dir) }}">
                Status <span class="sort-arrow"></span>
              </a>
            </th>
            <th>SR</th>
            <th>History</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="{% if invoice.status == 'paid' %}paid-invoice{% endif %}">
            <td class="row-number">{{ loop.index }}</td>
            <td data-value="{{ invoice.invoice_date }}">{{ invoice.invoice_date|german_date }}</td>
            <td data-value="{{ invoice.customer_name }}">
              {{ invoice.customer_name }}
              {% if invoice.name_needs_review %}
                <span class="name-review-badge" title="Name scheint ung√ºltig - bitte √ºberpr√ºfen!">‚ö†Ô∏è Name pr√ºfen</span>
              {% endif %}
            </td>
            <td data-value="{{ invoice.customer_address }}">
              {{ invoice.customer_address }}
              {% if invoice.address_incomplete %}
                <span class="incomplete-address-badge" title="Adresse wurde automatisch vervollst√§ndigt - bitte √ºberpr√ºfen!">‚ö†Ô∏è Adresse unvollst√§ndig</span>
              {% endif %}
            </td>
            <td data-value="{{ invoice.invoice_number or '' }}">{{ invoice.invoice_number or "‚Äì" }}</td>
            <td class="amount" data-value="{{ invoice.amount_eur }}">{{ "%.2f"|format(invoice.amount_eur) }} ‚Ç¨</td>
            <td data-value="{{ invoice.status }}">
              {% if invoice.status == 'paid' %}
                <span class="status-badge paid">‚úì Bezahlt ({{ invoice.last_seen_snapshot|german_month }})</span>
              {% else %}
                <span class="status-badge open">‚ö† Offen</span>
              {% endif %}
            </td>
            <td style="text-align: center;">
              {% if invoice.in_collective_invoice %}
                <span style="color: green; font-size: 1.2em;">‚úì</span>
              {% else %}
                ‚Äì
              {% endif %}
            </td>
            <td style="text-align: center;">
              <button class="history-btn" data-invoice-id="{{ invoice.id }}" data-invoice-number="{{ invoice.invoice_number or 'N/A' }}" data-customer-name="{{ invoice.customer_name }}" title="Verlauf anzeigen">
                üìã
              </button>
            </td>
            <td>
              {% if invoice.file_path %}
              <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}" target="_blank" rel="noopener">
                √ñffnen
              </a>
              {% else %}
              ‚Äì
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="empty">Keine passenden Rechnungen gefunden.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </section>

  <script>
    // Filter state - initialized with current filter values
    const filterState = {
      invoice_date_from: '{{ invoice_date_from }}',
      invoice_date_to: '{{ invoice_date_to }}',
      status: '{{ status_filter }}',
      email: '{{ email_filter }}',
      uncollectible: '{{ uncollectible_filter }}',
      collective: '{{ collective_filter }}'
    };

    // Default filter values
    const defaultFilters = {
      invoice_date_from: '',
      invoice_date_to: '',
      status: 'open',
      email: 'all',
      uncollectible: 'hide',
      collective: 'all'
    };

    // Filter Modal Toggle
    function toggleFilterModal() {
      const modal = document.getElementById('filterModal');
      modal.classList.toggle('show');
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('filterModal');
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // Handle filter button clicks
    document.querySelectorAll('#filterModal .filter-btn[data-filter]').forEach(btn => {
      btn.addEventListener('click', function() {
        const filterType = this.dataset.filter;
        const filterValue = this.dataset.value;
        const allowMulti = this.dataset.allowMulti === 'true';
        const siblingBtns = this.closest('.filter-buttons').querySelectorAll('.filter-btn');

        if (allowMulti && filterValue !== 'all') {
          // Multi-select mode for invoice_date
          const currentValues = filterState[filterType] === 'all' ? [] :
                                filterState[filterType].split(',').filter(v => v && v !== 'all');

          if (this.classList.contains('active')) {
            // Deactivate this value
            const newValues = currentValues.filter(v => v !== filterValue);
            filterState[filterType] = newValues.length > 0 ? newValues.join(',') : 'all';
            this.classList.remove('active');

            // If no values selected, activate "all"
            if (newValues.length === 0) {
              siblingBtns.forEach(b => {
                if (b.dataset.value === 'all') {
                  b.classList.add('active');
                }
              });
            }
          } else {
            // Activate this value
            if (!currentValues.includes(filterValue)) {
              currentValues.push(filterValue);
            }
            filterState[filterType] = currentValues.join(',');
            this.classList.add('active');

            // Deactivate "all" button
            siblingBtns.forEach(b => {
              if (b.dataset.value === 'all') {
                b.classList.remove('active');
              }
            });
          }
        } else {
          // Single-select mode (or "all" button clicked)
          filterState[filterType] = filterValue;
          siblingBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        }
      });
    });

    // Apply filters and navigate
    function applyFilters() {
      const params = new URLSearchParams(window.location.search);

      // Get date values from inputs
      const dateFrom = document.getElementById('invoice_date_from').value;
      const dateTo = document.getElementById('invoice_date_to').value;

      // Update filter params
      if (dateFrom) {
        params.set('invoice_date_from', dateFrom);
      } else {
        params.delete('invoice_date_from');
      }
      if (dateTo) {
        params.set('invoice_date_to', dateTo);
      } else {
        params.delete('invoice_date_to');
      }
      params.set('status', filterState.status);
      params.set('email', filterState.email);
      params.set('uncollectible', filterState.uncollectible);
      params.set('collective', filterState.collective);

      // Navigate to new URL
      window.location.href = '{{ url_for("index") }}?' + params.toString();
    }

    // Clear date input and update UI
    function clearDateInput(inputId) {
      const input = document.getElementById(inputId);
      const clearBtn = input.parentElement.querySelector('.date-clear-btn');
      input.value = '';
      input.classList.remove('has-value');
      if (clearBtn) clearBtn.style.display = 'none';
    }

    // Update date input UI when value changes
    function updateDateInputUI(input) {
      const clearBtn = input.parentElement.querySelector('.date-clear-btn');
      if (input.value) {
        input.classList.add('has-value');
        if (clearBtn) clearBtn.style.display = 'flex';
      } else {
        input.classList.remove('has-value');
        if (clearBtn) clearBtn.style.display = 'none';
      }
    }

    // Add event listeners to date inputs
    document.addEventListener('DOMContentLoaded', function() {
      const dateInputs = document.querySelectorAll('.filter-date-input');
      dateInputs.forEach(input => {
        input.addEventListener('change', function() {
          updateDateInputUI(this);
        });
        // Also update on focus out to catch any changes
        input.addEventListener('blur', function() {
          updateDateInputUI(this);
        });
      });
    });

    // Reset filters to defaults
    function resetFilters() {
      // Reset state to defaults
      Object.assign(filterState, defaultFilters);

      // Reset date inputs and their UI
      clearDateInput('invoice_date_from');
      clearDateInput('invoice_date_to');

      // Update button states visually
      document.querySelectorAll('#filterModal .filter-btn[data-filter]').forEach(btn => {
        const filterType = btn.dataset.filter;
        const filterValue = btn.dataset.value;

        if (defaultFilters[filterType] === filterValue) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Convert MM.JJJJ to YYYY-MM before form submission
    document.querySelector('.date-range-form-inline').addEventListener('submit', function(e) {
      e.preventDefault();

      const fromInput = document.getElementById('from_month');
      const toInput = document.getElementById('to_month');

      // Convert MM.JJJJ to YYYY-MM
      function convertToYYYYMM(value) {
        if (!value) return '';
        const match = value.match(/^(\d{2})\.(\d{4})$/);
        if (match) {
          return match[2] + '-' + match[1]; // YYYY-MM
        }
        return '';
      }

      const fromMonth = convertToYYYYMM(fromInput.value);
      const toMonth = convertToYYYYMM(toInput.value);

      // Create hidden inputs with converted values
      if (fromMonth) {
        const hiddenFrom = document.createElement('input');
        hiddenFrom.type = 'hidden';
        hiddenFrom.name = 'from_month';
        hiddenFrom.value = fromMonth;
        this.appendChild(hiddenFrom);
      }

      if (toMonth) {
        const hiddenTo = document.createElement('input');
        hiddenTo.type = 'hidden';
        hiddenTo.name = 'to_month';
        hiddenTo.value = toMonth;
        this.appendChild(hiddenTo);
      }

      // Submit the form
      this.submit();
    });

    // Print button handler
    document.getElementById('print-button').addEventListener('click', async function() {
      const button = this;
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);

      // Build API URL with current filter parameters
      const apiUrl = new URL('/api/print-invoices', window.location.origin);
      apiUrl.search = params.toString();

      button.disabled = true;
      button.textContent = '‚è≥ Erstelle PDF...';

      try {
        const response = await fetch(apiUrl);

        if (!response.ok) {
          const error = await response.json();
          alert('Fehler beim Erstellen des PDFs: ' + (error.error || 'Unbekannter Fehler'));
          return;
        }

        // Open PDF in new window for printing
        const blob = await response.blob();
        const pdfUrl = URL.createObjectURL(blob);

        // Create a link and trigger download/open
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.target = '_blank';
        link.download = 'rechnungen_druck.pdf';

        // Try to open in new window
        const printWindow = window.open(pdfUrl, '_blank');

        if (printWindow) {
          // Wait a bit for PDF to load, then trigger print
          setTimeout(() => {
            try {
              printWindow.print();
            } catch (e) {
              console.error('Print failed:', e);
            }
          }, 1000);
        } else {
          // Fallback: just download the PDF
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          alert('PDF wird heruntergeladen. Bitte √∂ffnen Sie es manuell zum Drucken.');
        }
      } catch (error) {
        alert('Fehler: ' + error.message);
      } finally {
        button.disabled = false;
        button.textContent = 'üñ® Rechnungen drucken ({{ invoices|length }})';
      }
    });

    // Email button handler with progress modal
    document.getElementById('email-button').addEventListener('click', async function() {
      const invoiceCount = {{ invoices|length }};
      if (!confirm(`M√∂chten Sie wirklich ${invoiceCount} Rechnung(en) per E-Mail versenden?`)) {
        return;
      }

      // Get modal elements
      const modal = document.getElementById('email-progress-modal');
      const summaryText = document.getElementById('email-summary-text');
      const spinner = document.getElementById('email-spinner');
      const progressBar = document.getElementById('email-progress-fill');
      const progressText = document.getElementById('email-progress-text');
      const progressLog = document.getElementById('email-progress-log');
      const closeBtn = document.getElementById('close-email-modal');

      // Open modal
      modal.classList.add('show');
      closeBtn.disabled = true;

      // Reset modal content
      summaryText.textContent = 'Bereite E-Mail-Versand vor...';
      spinner.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      progressLog.innerHTML = '';

      // Build API URL with current filter parameters
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);
      const apiUrl = new URL('/api/send-invoices-email-stream', window.location.origin);
      apiUrl.search = params.toString();

      // Create EventSource for server-sent events
      const eventSource = new EventSource(apiUrl);
      let totalGroups = 0;
      let totalInvoices = 0;

      // Helper function to add log entry
      function addLogEntry(type, message) {
        const entry = document.createElement('div');
        entry.className = `progress-log-entry ${type}`;

        let icon = '‚óè';
        if (type === 'success') icon = '‚úì';
        if (type === 'error') icon = '‚úó';
        if (type === 'info') icon = '‚Üí';

        entry.innerHTML = `
          <span class="log-icon">${icon}</span>
          <span class="log-message">${message}</span>
        `;
        progressLog.appendChild(entry);
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        switch(data.type) {
          case 'summary':
            totalGroups = data.total_groups;
            totalInvoices = data.total_invoices;
            summaryText.textContent = `Versende ${totalInvoices} Rechnung(en) an ${totalGroups} Empf√§nger`;
            addLogEntry('info', `Start: ${totalInvoices} Rechnung(en) an ${totalGroups} Empf√§nger`);
            break;

          case 'status':
            // Update the main status line (summaryText)
            summaryText.textContent = data.message;
            break;

          case 'info':
            addLogEntry('info', `Sende an ${data.email} (${data.count} Rechnung(en))...`);
            break;

          case 'success':
            addLogEntry('success', `‚úì Erfolgreich an ${data.email} versendet (${data.count} Rechnung(en))`);
            break;

          case 'error':
            const errorMsg = data.customer
              ? `‚úó Fehler bei ${data.customer}: ${data.message}`
              : `‚úó Fehler: ${data.message}`;
            addLogEntry('error', errorMsg);
            break;

          case 'progress':
            progressBar.style.width = data.progress + '%';
            progressText.textContent = data.progress + '%';
            break;

          case 'complete':
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            spinner.classList.add('hidden');
            const completionMsg = `Abgeschlossen: ${data.success} erfolgreich versendet${data.failed > 0 ? `, ${data.failed} fehlgeschlagen` : ''}`;
            addLogEntry('info', completionMsg);
            summaryText.textContent = completionMsg;
            closeBtn.disabled = false;
            eventSource.close();
            break;
        }
      };

      eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        spinner.classList.add('hidden');
        addLogEntry('error', 'Verbindungsfehler beim E-Mail-Versand');
        closeBtn.disabled = false;
        eventSource.close();
      };

      // Close button handler
      closeBtn.onclick = function() {
        modal.classList.remove('show');
        eventSource.close();
        window.location.reload(); // Reload to show updated status
      };
    });

    // Collective invoices button handler - opens options modal
    document.getElementById('collective-button').addEventListener('click', async function() {
      const modal = document.getElementById('collective-options-modal');
      const folderInput = document.getElementById('collective-folder-name');
      const sepaCheckbox = document.getElementById('collective-include-sepa');
      const emailConsentCheckbox = document.getElementById('collective-include-email-consent');
      const includeOlderCheckbox = document.getElementById('collective-include-older');
      const olderCountEl = document.getElementById('collective-older-count');

      // Set default folder name to previous month
      const today = new Date();
      const prevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      const defaultFolderName = prevMonth.getFullYear() + '-' + String(prevMonth.getMonth() + 1).padStart(2, '0');
      folderInput.value = defaultFolderName;

      // Reset checkboxes
      sepaCheckbox.checked = false;
      emailConsentCheckbox.checked = false;
      includeOlderCheckbox.checked = true; // Default: include older invoices

      // Reset and hide count display
      olderCountEl.style.display = 'none';
      olderCountEl.textContent = '';
      collectiveSettings.candidates = {};

      // Show modal
      modal.classList.add('show');

      // Load candidates in background to show count
      try {
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        if (!params.has('time')) params.set('time', 'current_month');
        if (!params.has('status')) params.set('status', 'open');
        if (!params.has('uncollectible')) params.set('uncollectible', 'hide');

        const candidatesUrl = new URL('/api/collective-invoice-candidates', window.location.origin);
        candidatesUrl.search = params.toString();

        const response = await fetch(candidatesUrl);
        const data = await response.json();

        const detailLink = document.getElementById('show-candidates-detail');
        if (data.success && Object.keys(data.candidates).length > 0) {
          collectiveSettings.candidates = data.candidates;
          // Count total invoices
          let totalInvoices = 0;
          let customerCount = Object.keys(data.candidates).length;
          for (const invoices of Object.values(data.candidates)) {
            totalInvoices += invoices.length;
          }
          olderCountEl.textContent = `${totalInvoices} √§ltere Rechnung${totalInvoices !== 1 ? 'en' : ''} von ${customerCount} Kunde${customerCount !== 1 ? 'n' : ''} gefunden`;
          olderCountEl.style.display = 'block';
          olderCountEl.style.color = '#2e7d32';
          if (detailLink) detailLink.style.display = 'inline';
        } else {
          olderCountEl.textContent = 'Keine √§lteren Rechnungen gefunden';
          olderCountEl.style.display = 'block';
          olderCountEl.style.color = '#666';
          if (detailLink) detailLink.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading candidates:', error);
      }
    });

    // Store collective invoice settings for use across modals
    let collectiveSettings = {
      folderName: '',
      includeSepa: false,
      includeEmailConsent: false,
      candidates: {},
      selectedAdditionalInvoices: {}
    };

    // Function to generate collective invoices
    async function generateCollectiveInvoices(additionalInvoices = {}) {
      const collectiveButton = document.getElementById('collective-button');
      const status = document.getElementById('collective-status');

      collectiveButton.disabled = true;
      collectiveButton.textContent = '‚è≥ Erstelle Sammelrechnungen...';
      status.textContent = '';
      status.className = 'collective-status';

      try {
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);

        params.set('include_sepa', collectiveSettings.includeSepa ? 'true' : 'false');
        params.set('include_email_consent', collectiveSettings.includeEmailConsent ? 'true' : 'false');
        params.set('folder_name', collectiveSettings.folderName);

        const apiUrl = new URL('/api/generate-collective-invoices', window.location.origin);
        apiUrl.search = params.toString();

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ additional_invoices: additionalInvoices })
        });

        const data = await response.json();

        if (data.success) {
          const resultModal = document.getElementById('collective-result-modal');
          document.getElementById('collective-count').textContent = data.count;
          document.getElementById('collective-total-invoices').textContent = data.total_invoices;
          document.getElementById('collective-folder').textContent = data.output_folder;

          const openFolderBtn = document.getElementById('open-folder-btn');
          openFolderBtn.dataset.folderPath = data.output_folder_absolute;

          resultModal.classList.add('show');

          status.textContent = `‚úì ${data.count} Sammelrechnung(en) erfolgreich erstellt`;
          status.className = 'collective-status success';
        } else {
          status.textContent = '‚úó Fehler: ' + (data.error || 'Unbekannter Fehler');
          status.className = 'collective-status error';
        }
      } catch (error) {
        status.textContent = '‚úó Netzwerkfehler: ' + error.message;
        status.className = 'collective-status error';
      } finally {
        collectiveButton.disabled = false;
        collectiveButton.textContent = 'üìÑ Sammelrechnungen erzeugen';
      }
    }

    // Store candidates globally for filtering
    let allInvoicesSorted = [];
    let uniqueDates = []; // Unique invoice dates sorted newest to oldest

    // Show candidates modal with checkboxes
    function showCandidatesModal(candidates) {
      // Calculate 8 weeks ago cutoff
      const eightWeeksAgo = new Date();
      eightWeeksAgo.setDate(eightWeeksAgo.getDate() - 56); // 8 weeks = 56 days

      // Flatten all invoices with customer info and sort by date
      allInvoicesSorted = [];
      for (const [customerName, invoices] of Object.entries(candidates)) {
        for (const invoice of invoices) {
          const dateObj = new Date(invoice.invoice_date);
          // Only include invoices within 8 weeks
          if (dateObj >= eightWeeksAgo) {
            allInvoicesSorted.push({
              ...invoice,
              customerName: customerName,
              dateObj: dateObj,
              dateString: invoice.invoice_date // Keep original date string for comparison
            });
          }
        }
      }
      // Sort by date (newest first)
      allInvoicesSorted.sort((a, b) => b.dateObj - a.dateObj);

      // Get unique dates (sorted newest to oldest)
      const dateSet = new Set();
      uniqueDates = [];
      for (const invoice of allInvoicesSorted) {
        if (!dateSet.has(invoice.dateString)) {
          dateSet.add(invoice.dateString);
          uniqueDates.push({
            dateString: invoice.dateString,
            dateObj: invoice.dateObj
          });
        }
      }

      // Configure slider based on unique dates
      const slider = document.getElementById('candidates-date-filter');
      if (uniqueDates.length > 0) {
        slider.min = 0;
        slider.max = uniqueDates.length - 1;
        slider.value = uniqueDates.length - 1; // Start with all dates (oldest)
        slider.step = 1;
      }

      // Render the candidates
      renderFilteredCandidates(uniqueDates.length - 1);

      document.getElementById('collective-candidates-modal').classList.add('show');
    }

    // Render candidates filtered by the slider value (index into uniqueDates)
    function renderFilteredCandidates(sliderValue) {
      const candidatesList = document.getElementById('candidates-list');
      const filterInfo = document.getElementById('candidates-filter-info');
      candidatesList.innerHTML = '';

      if (uniqueDates.length === 0) {
        filterInfo.textContent = 'Keine Rechnungen gefunden';
        return;
      }

      // Slider value is index: 0 = newest date only, max = all dates up to oldest
      const cutoffIndex = parseInt(sliderValue);
      const cutoffDate = uniqueDates[cutoffIndex].dateObj;

      // Filter invoices: show all from newest date down to cutoff date
      const invoicesToShow = allInvoicesSorted.filter(inv => inv.dateObj >= cutoffDate);

      // Get date range for display
      const newestDate = uniqueDates[0].dateObj.toLocaleDateString('de-DE');
      const oldestShownDate = uniqueDates[cutoffIndex].dateObj.toLocaleDateString('de-DE');

      const totalCount = allInvoicesSorted.length;
      const showCount = invoicesToShow.length;

      if (cutoffIndex === 0) {
        filterInfo.textContent = `${showCount} von ${totalCount} Rechnungen (nur ${newestDate})`;
      } else {
        filterInfo.textContent = `${showCount} von ${totalCount} Rechnungen (${oldestShownDate} bis ${newestDate})`;
      }

      // Group by customer for display
      const groupedByCustomer = {};
      for (const invoice of invoicesToShow) {
        if (!groupedByCustomer[invoice.customerName]) {
          groupedByCustomer[invoice.customerName] = [];
        }
        groupedByCustomer[invoice.customerName].push(invoice);
      }

      for (const [customerName, invoices] of Object.entries(groupedByCustomer)) {
        const customerSection = document.createElement('div');
        customerSection.style.cssText = 'margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: #f8f9fa; border-radius: 6px;';

        const customerHeader = document.createElement('div');
        customerHeader.style.cssText = 'font-weight: 600; margin-bottom: 0.25rem; color: #333; font-size: 0.9rem;';
        customerHeader.textContent = customerName;
        customerSection.appendChild(customerHeader);

        for (const invoice of invoices) {
          const invoiceLabel = document.createElement('label');
          invoiceLabel.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.2rem 0.25rem; cursor: pointer; border-radius: 3px; font-size: 0.85rem;';
          invoiceLabel.onmouseover = () => invoiceLabel.style.background = '#e9ecef';
          invoiceLabel.onmouseout = () => invoiceLabel.style.background = 'transparent';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = true; // Default: all selected
          checkbox.dataset.customername = customerName;
          checkbox.dataset.invoiceid = invoice.id;
          checkbox.style.cssText = 'width: 16px; height: 16px;';

          const formattedDate = invoice.dateObj.toLocaleDateString('de-DE');
          const formattedAmount = parseFloat(invoice.amount_eur).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          const invoiceNum = invoice.invoice_number || '-';

          const invoiceInfo = document.createElement('span');
          invoiceInfo.innerHTML = `${formattedDate} &mdash; <span style="color: #28a745; font-weight: 500;">${formattedAmount} ‚Ç¨</span> <span style="color: #888;">(${invoiceNum})</span>`;

          invoiceLabel.appendChild(checkbox);
          invoiceLabel.appendChild(invoiceInfo);
          customerSection.appendChild(invoiceLabel);
        }

        candidatesList.appendChild(customerSection);
      }
    }

    // Wait for DOM to be fully loaded before attaching event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Cancel collective options modal
      const cancelCollectiveBtn = document.getElementById('cancel-collective-options');
      if (cancelCollectiveBtn) {
        cancelCollectiveBtn.addEventListener('click', function() {
          document.getElementById('collective-options-modal').classList.remove('show');
        });
      }

      // Confirm collective options - generate with or without older invoices
      const confirmCollectiveBtn = document.getElementById('confirm-collective-options');
      if (confirmCollectiveBtn) {
        confirmCollectiveBtn.addEventListener('click', async function() {
          const modal = document.getElementById('collective-options-modal');
          const folderInput = document.getElementById('collective-folder-name');
          const sepaCheckbox = document.getElementById('collective-include-sepa');
          const emailConsentCheckbox = document.getElementById('collective-include-email-consent');
          const includeOlderCheckbox = document.getElementById('collective-include-older');

          // Validate folder name
          const cleanFolderName = folderInput.value.trim();
          if (!cleanFolderName) {
            alert('Bitte geben Sie eine g√ºltige Bezeichnung ein.');
            return;
          }

          // Store settings
          collectiveSettings.folderName = cleanFolderName;
          collectiveSettings.includeSepa = sepaCheckbox.checked;
          collectiveSettings.includeEmailConsent = emailConsentCheckbox.checked;
          collectiveSettings.selectedAdditionalInvoices = {};

          // Close options modal
          modal.classList.remove('show');

          // Check if we should include older invoices
          if (includeOlderCheckbox.checked && Object.keys(collectiveSettings.candidates).length > 0) {
            // Auto-include ALL older invoices (candidates already loaded when modal opened)
            const allCandidatesSelected = {};
            for (const [customerName, invoices] of Object.entries(collectiveSettings.candidates)) {
              allCandidatesSelected[customerName] = invoices.map(inv => inv.id);
            }
            console.log('Auto-including all older invoices:', allCandidatesSelected);
            generateCollectiveInvoices(allCandidatesSelected);
          } else {
            // Generate without older invoices
            generateCollectiveInvoices({});
          }
        });
      }

      // "Auswahl anpassen" link - opens the detailed candidates modal
      const showCandidatesDetailLink = document.getElementById('show-candidates-detail');
      if (showCandidatesDetailLink) {
        showCandidatesDetailLink.addEventListener('click', function(e) {
          e.preventDefault();

          // Store current settings before switching modals
          const folderInput = document.getElementById('collective-folder-name');
          const sepaCheckbox = document.getElementById('collective-include-sepa');
          const emailConsentCheckbox = document.getElementById('collective-include-email-consent');

          collectiveSettings.folderName = folderInput.value.trim();
          collectiveSettings.includeSepa = sepaCheckbox.checked;
          collectiveSettings.includeEmailConsent = emailConsentCheckbox.checked;

          if (Object.keys(collectiveSettings.candidates).length > 0) {
            // Close options modal and show candidates modal
            document.getElementById('collective-options-modal').classList.remove('show');
            showCandidatesModal(collectiveSettings.candidates);
          } else {
            alert('Keine √§lteren Rechnungen zum Ausw√§hlen verf√ºgbar.');
          }
        });
      }

      // Date filter slider for candidates
      const dateFilterSlider = document.getElementById('candidates-date-filter');
      if (dateFilterSlider) {
        dateFilterSlider.addEventListener('input', function() {
          renderFilteredCandidates(parseInt(this.value));
        });
      }

      // Cancel candidates - abort the entire process
      const cancelCandidatesBtn = document.getElementById('cancel-candidates');
      if (cancelCandidatesBtn) {
        cancelCandidatesBtn.addEventListener('click', function() {
          document.getElementById('collective-candidates-modal').classList.remove('show');
          // Don't call generateCollectiveInvoices - just abort
        });
      }

      // Skip candidates - generate without additional invoices
      const skipCandidatesBtn = document.getElementById('skip-candidates');
      if (skipCandidatesBtn) {
        skipCandidatesBtn.addEventListener('click', function() {
          document.getElementById('collective-candidates-modal').classList.remove('show');
          generateCollectiveInvoices({});
        });
      }

      // Add selected candidates and generate
      const addSelectedBtn = document.getElementById('add-selected-candidates');
      if (addSelectedBtn) {
        addSelectedBtn.addEventListener('click', function() {
          const selectedInvoices = {};

          // Collect all checked checkboxes
          document.querySelectorAll('#candidates-list input[type="checkbox"]:checked').forEach(checkbox => {
            const customerName = checkbox.dataset.customername;
            const invoiceId = parseInt(checkbox.dataset.invoiceid);

            if (!selectedInvoices[customerName]) {
              selectedInvoices[customerName] = [];
            }
            selectedInvoices[customerName].push(invoiceId);
          });

          document.getElementById('collective-candidates-modal').classList.remove('show');
          generateCollectiveInvoices(selectedInvoices);
        });
      }

      // Close collective modal handler
      const closeBtn = document.getElementById('close-collective-modal');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          console.log('Schlie√üen-Button geklickt');
          document.getElementById('collective-result-modal').classList.remove('show');
        });
      }

      // Open folder button handler
      const openFolderBtn = document.getElementById('open-folder-btn');
      if (openFolderBtn) {
        openFolderBtn.addEventListener('click', async function() {
          console.log('Ordner √∂ffnen-Button geklickt');
          const folderPath = this.dataset.folderPath;
          console.log('Ordnerpfad:', folderPath);

          if (folderPath) {
            try {
              const response = await fetch('/api/open-folder', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ folder_path: folderPath })
              });

              const data = await response.json();

              if (data.success) {
                console.log('Ordner erfolgreich ge√∂ffnet');
              } else {
                console.error('Fehler beim √ñffnen:', data.error);
                alert('Fehler beim √ñffnen des Ordners: ' + data.error);
              }
            } catch (error) {
              console.error('Netzwerkfehler:', error);
              alert('Netzwerkfehler: ' + error.message);
            }
          } else {
            console.error('Kein Ordnerpfad vorhanden');
            alert('Kein Ordnerpfad vorhanden');
          }
        });
      }

    });

    document.getElementById('scan-button').addEventListener('click', function() {
      const modal = document.getElementById('scan-progress-modal');
      const progressBar = document.getElementById('scan-progress-fill');
      const progressText = document.getElementById('scan-progress-text');
      const progressLog = document.getElementById('scan-progress-log');
      const closeBtn = document.getElementById('close-scan-modal');
      const summaryDiv = document.getElementById('scan-summary');

      // Show modal
      modal.style.display = 'block';
      closeBtn.disabled = true;
      progressLog.innerHTML = '';
      summaryDiv.innerHTML = '<p>Starte Scan...</p>';

      // Create EventSource for Server-Sent Events
      const eventSource = new EventSource('/api/scan-stream');

      let totalFiles = 0;
      let processedFiles = 0;
      let successCount = 0;
      let skippedCount = 0;
      let errorCount = 0;
      const errors = [];

      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'summary') {
          totalFiles = data.total;
          summaryDiv.innerHTML = `<p>Scanne ${totalFiles} PDF-Dateien...</p>`;
        } else if (data.type === 'progress') {
          processedFiles = data.processed;
          const progress = data.progress;
          progressBar.style.width = progress + '%';
          progressText.textContent = `${progress}% (${processedFiles}/${totalFiles})`;
        } else if (data.type === 'success') {
          successCount++;
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry log-success';
          logEntry.textContent = `‚úì ${data.file}`;
          progressLog.appendChild(logEntry);
          progressLog.scrollTop = progressLog.scrollHeight;
        } else if (data.type === 'skipped') {
          skippedCount++;
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry log-info';
          logEntry.textContent = `‚Ü∑ ${data.file} (bereits vorhanden)`;
          progressLog.appendChild(logEntry);
          progressLog.scrollTop = progressLog.scrollHeight;
        } else if (data.type === 'error') {
          if (data.file) {
            errorCount++;
            errors.push(`${data.file}: ${data.message}`);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-error';
            logEntry.textContent = `‚úó ${data.file}: ${data.message}`;
            progressLog.appendChild(logEntry);
            progressLog.scrollTop = progressLog.scrollHeight;
          } else {
            summaryDiv.innerHTML = `<p class="error">Fehler: ${data.message}</p>`;
            eventSource.close();
            closeBtn.disabled = false;
          }
        } else if (data.type === 'complete') {
          eventSource.close();
          progressBar.style.width = '100%';
          progressText.textContent = '100%';

          let summaryHTML = '<div class="scan-complete-summary">';
          summaryHTML += `<p><strong>Scan abgeschlossen!</strong></p>`;
          summaryHTML += `<p>‚úì Neu importiert: ${data.success}</p>`;
          summaryHTML += `<p>‚Ü∑ √úbersprungen: ${data.skipped}</p>`;

          if (data.failed > 0) {
            summaryHTML += `<p>‚úó Fehler: ${data.failed}</p>`;
            summaryHTML += '<details><summary>Fehlerdetails anzeigen</summary><div class="error-details">';
            data.errors.forEach(err => {
              summaryHTML += `<div>${err}</div>`;
            });
            summaryHTML += '</div></details>';
          }

          summaryHTML += '</div>';
          summaryDiv.innerHTML = summaryHTML;
          closeBtn.disabled = false;

          // Close scan modal and run batch salutations, then check pending imports
          eventSource.close();
          modal.style.display = 'none';

          // First run batch salutations with progress popup, then name validation
          runBatchSalutations().then(() => {
            return runBatchNameValidation();
          }).then(() => {
            // Then check for pending imports
            fetch('/api/pending-imports')
              .then(response => response.json())
              .then(pendingData => {
                if (pendingData.success && pendingData.count > 0) {
                  // Show pending imports modal
                  setTimeout(() => {
                    if (window.showPendingImportsModal) {
                      window.showPendingImportsModal();
                    }
                  }, 300);
                } else if (data.success > 0 || data.skipped > 0) {
                  // Reload page after short delay if invoices were imported/skipped
                  setTimeout(() => window.location.reload(), 500);
                }
              })
              .catch(error => {
                console.error('Error checking pending imports:', error);
                // Fallback: just reload if new invoices
                if (data.success > 0) {
                  setTimeout(() => window.location.reload(), 500);
                }
              });
          });
        }
      };

      eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        summaryDiv.innerHTML = '<p class="error">Verbindungsfehler beim Scannen</p>';
        eventSource.close();
        closeBtn.disabled = false;
      };

      // Close button handler
      closeBtn.onclick = function() {
        eventSource.close();
        modal.style.display = 'none';

        // First run batch salutations, then name validation, then check for pending imports
        runBatchSalutations().then(() => {
          return runBatchNameValidation();
        }).then(() => {
          fetch('/api/pending-imports')
            .then(response => response.json())
            .then(pendingData => {
              if (pendingData.success && pendingData.count > 0) {
                setTimeout(() => {
                  if (window.showPendingImportsModal) {
                    window.showPendingImportsModal();
                  }
                }, 300);
              } else if (successCount > 0) {
                window.location.reload();
              }
            })
            .catch(error => {
              console.error('Error checking pending imports:', error);
              if (successCount > 0) {
                window.location.reload();
              }
            });
        });
      };
    });
  </script>

  <!-- Scan Progress Modal -->
  <div id="scan-progress-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Rechnungen scannen</h2>
      </div>
      <div class="modal-body">
        <div id="scan-summary" class="scan-summary"></div>
        <div id="scan-progress-container" class="progress-container">
          <div id="scan-progress-bar" class="progress-bar">
            <div id="scan-progress-fill" class="progress-fill"></div>
          </div>
          <div id="scan-progress-text" class="progress-text">0%</div>
        </div>
        <div id="scan-progress-log" class="progress-log"></div>
      </div>
      <div class="modal-footer">
        <button id="close-scan-modal" class="modal-close-btn" disabled>Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Email Progress Modal -->
  <div id="email-progress-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>E-Mail Versand</h2>
      </div>
      <div class="modal-body">
        <div id="email-summary" class="email-summary">
          <div id="email-spinner" class="status-spinner"></div>
          <span id="email-summary-text"></span>
        </div>
        <div id="email-progress-container" class="progress-container">
          <div id="email-progress-bar" class="progress-bar">
            <div id="email-progress-fill" class="progress-fill"></div>
          </div>
          <div id="email-progress-text" class="progress-text">0%</div>
        </div>
        <div id="email-progress-log" class="progress-log"></div>
      </div>
      <div class="modal-footer">
        <button id="close-email-modal" class="modal-close-btn" disabled>Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Collective Invoices Options Modal -->
  <div id="collective-options-modal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2>üìÑ Sammelrechnungen erzeugen</h2>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <div style="margin-bottom: 1.5rem;">
          <label for="collective-folder-name" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Ordnername:</label>
          <input type="text" id="collective-folder-name" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;" placeholder="z.B. 2025-12">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; border-radius: 6px; background: #f8f9fa;">
            <input type="checkbox" id="collective-include-sepa" style="margin-top: 0.2rem; width: 18px; height: 18px;">
            <div>
              <span style="font-weight: 500;">SEPA-Lastschriftmandat beif√ºgen</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">Wird automatisch √ºbersprungen f√ºr Kunden mit aktiviertem Bankeinzug</p>
            </div>
          </label>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; border-radius: 6px; background: #f8f9fa;">
            <input type="checkbox" id="collective-include-email-consent" style="margin-top: 0.2rem; width: 18px; height: 18px;">
            <div>
              <span style="font-weight: 500;">E-Mail-Einwilligungsformular beif√ºgen</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">Kundenname wird automatisch eingetragen</p>
            </div>
          </label>
        </div>
        <div style="margin-bottom: 1rem; border-top: 1px solid #e9ecef; padding-top: 1rem;">
          <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; border-radius: 6px; background: #e8f5e9;">
            <input type="checkbox" id="collective-include-older" checked style="margin-top: 0.2rem; width: 18px; height: 18px;">
            <div style="flex: 1;">
              <span style="font-weight: 500;">√Ñltere offene Rechnungen einbeziehen</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">Rechnungen der letzten 8 Wochen, die noch nicht in einer Sammelrechnung enthalten sind</p>
              <p id="collective-older-count" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #2e7d32; font-weight: 500; display: none;"></p>
            </div>
          </label>
          <div style="margin-top: 0.5rem; padding-left: 2.5rem;">
            <a href="#" id="show-candidates-detail" style="font-size: 0.85rem; color: #1976d2; text-decoration: none; display: none;">Auswahl anpassen...</a>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.75rem; justify-content: flex-end;">
        <button id="cancel-collective-options" class="modal-close-btn">Abbrechen</button>
        <button id="confirm-collective-options" class="btn-resolve-footer" style="background: #4CAF50;">Erstellen</button>
      </div>
    </div>
  </div>

  <!-- Collective Invoice Candidates Modal -->
  <div id="collective-candidates-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header" style="padding: 0.75rem 1rem;">
        <h2 style="font-size: 1.1rem; margin: 0;">Weitere Rechnungen (letzte 8 Wochen)</h2>
        <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.8rem;">
          Offene Rechnungen, die noch nicht in einer Sammelrechnung enthalten sind.
        </p>
      </div>
      <div style="padding: 0.5rem 1rem; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <span style="font-size: 0.8rem; color: #666; white-space: nowrap;">Neuere</span>
          <input type="range" id="candidates-date-filter" min="0" max="100" value="100"
                 style="flex: 1; height: 5px; cursor: pointer; accent-color: #4CAF50;">
          <span style="font-size: 0.8rem; color: #666; white-space: nowrap;">√Ñltere</span>
        </div>
        <div style="text-align: center; margin-top: 0.25rem;">
          <span id="candidates-filter-info" style="font-size: 0.8rem; color: #333; font-weight: 500;"></span>
        </div>
      </div>
      <div class="modal-body" style="padding: 0.75rem 1rem; max-height: 350px; overflow-y: auto;">
        <div id="candidates-list"></div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.75rem; justify-content: flex-end;">
        <button id="cancel-candidates" class="modal-close-btn" style="color: #dc3545;">Abbrechen</button>
        <button id="skip-candidates" class="modal-close-btn">√úberspringen</button>
        <button id="add-selected-candidates" class="btn-resolve-footer" style="background: #4CAF50;">Ausgew√§hlte anf√ºgen</button>
      </div>
    </div>
  </div>

  <!-- Collective Invoices Result Modal -->
  <div id="collective-result-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sammelrechnungen erstellt</h2>
      </div>
      <div class="modal-body">
        <div id="collective-summary" class="collective-summary">
          <div class="stat-row">
            <span class="stat-label">Anzahl Sammelrechnungen:</span>
            <span class="stat-value" id="collective-count">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Enthaltene Einzelrechnungen:</span>
            <span class="stat-value" id="collective-total-invoices">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Gespeichert in:</span>
            <span class="stat-value" id="collective-folder">-</span>
          </div>
        </div>
        <div id="collective-open-folder" class="folder-link-container">
          <button id="open-folder-btn" class="open-folder-btn">üìÅ Ordner √∂ffnen</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="close-collective-modal" class="modal-close-btn">Schlie√üen</button>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="history-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>Rechnungs-Verlauf</h2>
    </div>
    <div class="modal-body" style="padding: 2rem;">
      <div id="history-invoice-info" style="margin-bottom: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">
          <strong>Kunde:</strong>
          <span id="history-customer-name">-</span>
          <strong>Rechnungsnr.:</strong>
          <span id="history-invoice-number">-</span>
          <strong>Datum:</strong>
          <span id="history-invoice-date">-</span>
          <strong>Betrag:</strong>
          <span id="history-invoice-amount">-</span>
        </div>
      </div>
      <div id="history-loading" style="text-align: center; padding: 2rem;">
        Lade Verlauf...
      </div>
      <div id="history-timeline" style="max-height: 400px; overflow-y: auto;">
      </div>
    </div>
    <div class="modal-footer">
      <button id="print-history-btn" class="modal-close-btn" style="background: #123C69; color: white; margin-right: 0.5rem;">üñ®Ô∏è Verlauf drucken</button>
      <button id="close-history-modal" class="modal-close-btn">Schlie√üen</button>
    </div>
  </div>
</div>

<script>
  // History Modal Logic
  (function() {
    const modal = document.getElementById('history-modal');
    const closeBtn = document.getElementById('close-history-modal');
    const printBtn = document.getElementById('print-history-btn');
    const historyBtns = document.querySelectorAll('.history-btn');

    // Store current invoice ID for printing
    let currentInvoiceId = null;

    // Event type translations
    const eventTypeTranslations = {
      'IMPORT': 'Import',
      'EMAIL_SENT': 'E-Mail versendet',
      'COLLECTIVE_INVOICE_CREATED': 'Sammelrechnung erstellt',
      'COLLECTIVE_INVOICE_SENT': 'Sammelrechnung versendet',
      'REMINDER_CREATED': 'Mahnung erstellt',
      'REMINDER_SENT': 'Mahnung versendet',
      'MARKED_UNCOLLECTIBLE': 'Als uneinbringbar markiert',
      'UNMARKED_UNCOLLECTIBLE': 'Uneinbringbar-Status aufgehoben'
    };

    // Event type icons
    const eventTypeIcons = {
      'IMPORT': 'üì•',
      'EMAIL_SENT': '‚úâÔ∏è',
      'COLLECTIVE_INVOICE_CREATED': 'üìÑ',
      'COLLECTIVE_INVOICE_SENT': 'üìÆ',
      'REMINDER_CREATED': '‚ö†Ô∏è',
      'REMINDER_SENT': 'üì®',
      'MARKED_UNCOLLECTIBLE': '‚ùå',
      'UNMARKED_UNCOLLECTIBLE': '‚úÖ'
    };

    // Reminder level translations
    const reminderLevelTranslations = {
      0: 'Zahlungserinnerung',
      1: '1. Mahnung',
      2: '2. Mahnung'
    };

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatEventDetails(eventType, metadata) {
      const details = [];

      if (metadata.email) {
        details.push(`E-Mail: ${metadata.email}`);
      }

      if (metadata.letterxpress_job_id) {
        details.push(`LetterXpress Job: #${metadata.letterxpress_job_id}`);
      }

      if (metadata.price !== undefined) {
        details.push(`Kosten: ${metadata.price.toFixed(2)} ‚Ç¨`);
      }

      if (metadata.reminder_level !== undefined) {
        details.push(`Stufe: ${reminderLevelTranslations[metadata.reminder_level] || metadata.reminder_level}`);
      }

      if (metadata.filename) {
        details.push(`Datei: ${metadata.filename}`);
      }

      if (metadata.mode) {
        details.push(`Modus: ${metadata.mode}`);
      }

      return details.length > 0 ? details.join(' ‚Ä¢ ') : '';
    }

    function loadHistory(invoiceId, customerName, invoiceNumber) {
      // Store invoice ID for printing
      currentInvoiceId = invoiceId;

      // Show modal
      modal.classList.add('show');

      // Reset content
      document.getElementById('history-loading').style.display = 'block';
      document.getElementById('history-loading').textContent = 'Lade Verlauf...';
      document.getElementById('history-timeline').innerHTML = '';

      // Fetch history
      fetch(`/api/invoices/${invoiceId}/history`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update invoice info
            document.getElementById('history-customer-name').textContent = data.invoice.customer_name;
            document.getElementById('history-invoice-number').textContent = data.invoice.invoice_number || 'N/A';
            document.getElementById('history-invoice-date').textContent = formatTimestamp(data.invoice.invoice_date);
            document.getElementById('history-invoice-amount').textContent = `${data.invoice.amount_eur.toFixed(2)} ‚Ç¨`;

            // Build timeline
            const timeline = document.getElementById('history-timeline');
            timeline.innerHTML = '';

            if (data.events.length === 0) {
              timeline.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Noch keine Ereignisse f√ºr diese Rechnung.</div>';
            } else {
              const timelineList = document.createElement('div');
              timelineList.style.cssText = 'position: relative; padding-left: 2rem;';

              data.events.forEach((event, index) => {
                const eventItem = document.createElement('div');
                eventItem.style.cssText = 'position: relative; padding-bottom: 1.5rem;';

                // Timeline line
                if (index < data.events.length - 1) {
                  const line = document.createElement('div');
                  line.style.cssText = 'position: absolute; left: -1.4rem; top: 1.5rem; bottom: 0; width: 2px; background: #ddd;';
                  eventItem.appendChild(line);
                }

                // Timeline dot
                const dot = document.createElement('div');
                dot.style.cssText = 'position: absolute; left: -1.8rem; top: 0.3rem; width: 1rem; height: 1rem; border-radius: 50%; background: #4CAF50; border: 3px solid white; box-shadow: 0 0 0 1px #ddd;';
                eventItem.appendChild(dot);

                // Event content
                const content = document.createElement('div');
                const icon = eventTypeIcons[event.event_type] || '‚Ä¢';
                const eventName = eventTypeTranslations[event.event_type] || event.event_type;
                const details = formatEventDetails(event.event_type, event.metadata);

                content.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 0.25rem;">
                    ${icon} ${eventName}
                  </div>
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                    ${formatTimestamp(event.timestamp)}
                  </div>
                  ${details ? `<div style="font-size: 0.85rem; color: #444;">${details}</div>` : ''}
                `;
                eventItem.appendChild(content);

                timelineList.appendChild(eventItem);
              });

              timeline.appendChild(timelineList);
            }

            // Hide loading
            document.getElementById('history-loading').style.display = 'none';
          } else {
            document.getElementById('history-timeline').innerHTML = `<div style="text-align: center; padding: 2rem; color: #d32f2f;">Fehler: ${data.error}</div>`;
          }
        })
        .catch(error => {
          console.error('Error loading history:', error);
          document.getElementById('history-timeline').innerHTML = `<div style="text-align: center; padding: 2rem; color: #d32f2f;">Fehler beim Laden des Verlaufs.</div>`;
        });
    }

    // Attach click handlers to all history buttons
    historyBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const invoiceId = this.getAttribute('data-invoice-id');
        const customerName = this.getAttribute('data-customer-name');
        const invoiceNumber = this.getAttribute('data-invoice-number');
        loadHistory(invoiceId, customerName, invoiceNumber);
      });
    });

    // Print history handler
    printBtn.addEventListener('click', function() {
      if (currentInvoiceId) {
        window.open(`/api/invoices/${currentInvoiceId}/history/pdf`, '_blank');
      }
    });

    // Close modal handler
    closeBtn.addEventListener('click', function() {
      modal.classList.remove('show');
    });

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });
  })();

  // Pending Imports Modal
  (function() {
    let currentImports = [];
    let currentIndex = 0;

    function showPendingImportsModal() {
      // Get elements when function is called (modal HTML should be loaded by now)
      const modal = document.getElementById('pending-imports-modal');
      const importsList = document.getElementById('pending-imports-list');
      const pendingCount = document.getElementById('pending-imports-count');

      if (!modal || !importsList || !pendingCount) {
        console.error('Pending imports modal elements not found');
        return;
      }

      // Fetch pending imports
      fetch('/api/pending-imports')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.count > 0) {
            currentImports = data.pending_imports;
            currentIndex = 0;
            pendingCount.textContent = data.count;
            renderCurrentImport();
            updateNavigationButtons();
            modal.classList.add('show');
          }
        })
        .catch(error => {
          console.error('Error fetching pending imports:', error);
        });
    }

    function renderCurrentImport() {
      const importsList = document.getElementById('pending-imports-list');
      const currentIndexEl = document.getElementById('pending-current-index');

      if (!currentImports || currentImports.length === 0) return;

      const imp = currentImports[currentIndex];
      currentIndexEl.textContent = currentIndex + 1;

      importsList.innerHTML = '';
      const importDiv = document.createElement('div');
      importDiv.className = 'pending-import-item';
      importDiv.innerHTML = `
        <div class="pending-import-header">
          <div>
            <strong>Neue Rechnung:</strong> ${imp.invoice_number || 'ohne Nummer'} ¬∑ ${imp.invoice_date}
          </div>
          <span class="pending-import-amount">${(imp.amount_euros).toFixed(2)} ‚Ç¨</span>
        </div>

        <div class="similar-customers-section">
          ${imp.similar_customers.map((customer, idx) => `
            <div class="similar-customer-group">
              <div class="comparison-header">
                <span class="similarity-score">${customer.similarity_score}% √§hnlich</span>
                <span style="color: #666; font-size: 0.85rem;">${customer.invoice_count} Rechnung(en) vorhanden</span>
              </div>

              <div class="comparison-container">
                <div class="comparison-column comparison-new">
                  <div class="comparison-label">üìÑ Neue Rechnung</div>
                  <div class="comparison-name">${customer.new_name_highlighted || imp.customer_name}</div>
                  <div class="comparison-address">${customer.new_street_highlighted || imp.customer_street}</div>
                  <div class="comparison-address">${customer.new_city_highlighted || imp.customer_city}</div>
                </div>

                <div class="comparison-divider">‚Üî</div>

                <div class="comparison-column comparison-existing">
                  <div class="comparison-label">üíæ In Datenbank</div>
                  <div class="comparison-name">${customer.customer_name_highlighted || customer.customer_name}</div>
                  <div class="comparison-address">${customer.customer_street_highlighted || customer.customer_street}</div>
                  <div class="comparison-address">${customer.customer_city_highlighted || customer.customer_city}</div>
                </div>
              </div>

              <div class="comparison-options">
                <div class="similar-customer-option">
                  <input type="radio"
                         id="customer-${imp.id}-${idx}-new"
                         name="customer-${imp.id}"
                         value="${idx}-new"
                         ${idx === 0 ? 'checked' : ''}>
                  <label for="customer-${imp.id}-${idx}-new">
                    <strong>üìÑ Neue Version verwenden</strong>
                    <span style="font-size: 0.85em; color: #666; display: block; margin-top: 0.15rem;">
                      (${customer.invoice_count} bestehende Rechnung(en) aktualisieren)
                    </span>
                  </label>
                </div>
                <div class="similar-customer-option">
                  <input type="radio"
                         id="customer-${imp.id}-${idx}-old"
                         name="customer-${imp.id}"
                         value="${idx}-old">
                  <label for="customer-${imp.id}-${idx}-old">
                    <strong>üíæ Datenbank-Version verwenden</strong>
                    <span style="font-size: 0.85em; color: #666; display: block; margin-top: 0.15rem;">
                      (Bestehende Daten behalten)
                    </span>
                  </label>
                </div>
              </div>
            </div>
          `).join('')}

          <div class="similar-customer-option" style="margin-top: 1rem; border: 2px dashed #ddd;">
            <input type="radio"
                   id="customer-${imp.id}-new"
                   name="customer-${imp.id}"
                   value="new">
            <label for="customer-${imp.id}-new">
              <strong>‚ûï Als komplett neuen Kunden anlegen</strong>
              <span style="font-size: 0.85em; color: #666; display: block; margin-top: 0.15rem;">
                (Nicht zusammenf√ºhren)
              </span>
            </label>
          </div>
        </div>

      `;
      importsList.appendChild(importDiv);

      // Update the resolve button in footer
      const confirmBtn = document.getElementById('pending-confirm-btn');
      if (confirmBtn) {
        // Remove old event listeners by cloning
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        // Add new event listener
        newConfirmBtn.addEventListener('click', function() {
          const importId = imp.id;
          const customersData = imp.similar_customers;
          const selectedRadio = document.querySelector(`input[name="customer-${importId}"]:checked`);

          if (!selectedRadio) {
            alert('Bitte w√§hlen Sie eine Option aus');
            return;
          }

          const selectedValue = selectedRadio.value;
          let action, selectedCustomer, useNewData = false;

          if (selectedValue === 'new') {
            action = 'create_new';
            selectedCustomer = null;
          } else if (selectedValue.endsWith('-old')) {
            action = 'merge_with_existing';
            const idx = parseInt(selectedValue.split('-')[0]);
            selectedCustomer = customersData[idx];
            useNewData = false;
          } else if (selectedValue.endsWith('-new')) {
            action = 'merge_with_existing';
            const idx = parseInt(selectedValue.split('-')[0]);
            selectedCustomer = customersData[idx];
            useNewData = true;
          }

          resolveImport(importId, action, selectedCustomer, useNewData);
        });
      }
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('pending-prev-btn');
      const nextBtn = document.getElementById('pending-next-btn');

      if (prevBtn) {
        prevBtn.disabled = currentIndex === 0;
        prevBtn.style.opacity = currentIndex === 0 ? '0.5' : '1';
      }

      if (nextBtn) {
        nextBtn.disabled = currentIndex >= currentImports.length - 1;
        nextBtn.style.opacity = currentIndex >= currentImports.length - 1 ? '0.5' : '1';
      }
    }

    function navigatePrev() {
      if (currentIndex > 0) {
        currentIndex--;
        renderCurrentImport();
        updateNavigationButtons();
      }
    }

    function navigateNext() {
      if (currentIndex < currentImports.length - 1) {
        currentIndex++;
        renderCurrentImport();
        updateNavigationButtons();
      }
    }

    function resolveImport(importId, action, selectedCustomer, useNewData = false) {
      const modal = document.getElementById('pending-imports-modal');

      fetch('/api/resolve-import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          import_id: importId,
          action: action,
          selected_customer: selectedCustomer,
          use_new_data: useNewData
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove resolved import from array
          currentImports = currentImports.filter(imp => imp.id !== importId);

          if (currentImports.length > 0) {
            // Adjust index if needed
            if (currentIndex >= currentImports.length) {
              currentIndex = currentImports.length - 1;
            }
            // Update count and render
            document.getElementById('pending-imports-count').textContent = currentImports.length;
            renderCurrentImport();
            updateNavigationButtons();
          } else {
            // No more imports, close modal and reload
            if (modal) modal.classList.remove('show');
            window.location.reload();
          }
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      })
      .catch(error => {
        console.error('Error resolving import:', error);
        alert('Fehler beim Aufl√∂sen des Imports');
      });
    }

    // Make function globally accessible
    window.showPendingImportsModal = showPendingImportsModal;

    // Set up event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('pending-imports-modal');
      const closeBtn = document.getElementById('close-pending-imports-modal');
      const prevBtn = document.getElementById('pending-prev-btn');
      const nextBtn = document.getElementById('pending-next-btn');

      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (modal) modal.classList.remove('show');
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', navigatePrev);
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', navigateNext);
      }

      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.remove('show');
          }
        });
      }
    });
  })();

  // Check for pending imports on page load
  (function() {
    const button = document.getElementById('pending-imports-button');
    const badge = document.getElementById('pending-imports-badge');

    function updatePendingImportsBadge() {
      fetch('/api/pending-imports')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.count > 0) {
            if (badge && button) {
              badge.textContent = data.count;
              button.style.display = 'inline-block';
            }
          } else {
            if (button) {
              button.style.display = 'none';
            }
          }
        })
        .catch(error => console.error('Error checking pending imports:', error));
    }

    // Set up click handler
    if (button) {
      button.addEventListener('click', function() {
        if (window.showPendingImportsModal) {
          window.showPendingImportsModal();
        } else {
          console.error('showPendingImportsModal function not found');
        }
      });
    }

    // Update badge on page load
    updatePendingImportsBadge();

    // Update badge every 30 seconds
    setInterval(updatePendingImportsBadge, 30000);
  })();

  // Batch Salutations Function
  function runBatchSalutations() {
    return new Promise((resolve) => {
      const modal = document.getElementById('salutation-progress-modal');
      const progressBar = document.getElementById('salutation-progress-bar');
      const progressText = document.getElementById('salutation-progress-text');
      const statusText = document.getElementById('salutation-status-text');

      modal.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = 'Starte...';
      statusText.textContent = '';

      const eventSource = new EventSource('/api/batch-salutations-stream');

      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'start') {
          progressText.textContent = `0 / ${data.total} Kunden`;
        } else if (data.type === 'progress') {
          const percent = Math.round((data.processed / data.total) * 100);
          progressBar.style.width = percent + '%';
          progressText.textContent = `${data.processed} / ${data.total} Kunden`;
          if (data.batch && data.batch.length > 0) {
            statusText.textContent = `Verarbeite: ${data.batch.slice(0, 5).join(', ')}${data.batch.length > 5 ? '...' : ''}`;
          }
        } else if (data.type === 'complete') {
          progressBar.style.width = '100%';
          progressText.textContent = data.message;
          statusText.textContent = `‚úì ${data.success} von ${data.total} Anreden ermittelt`;
          eventSource.close();
          setTimeout(() => {
            modal.style.display = 'none';
            resolve(data);
          }, 1500);
        } else if (data.type === 'error') {
          progressText.textContent = 'Fehler!';
          statusText.textContent = data.message;
          eventSource.close();
          setTimeout(() => {
            modal.style.display = 'none';
            resolve({ error: data.message });
          }, 2000);
        }
      };

      eventSource.onerror = function() {
        eventSource.close();
        modal.style.display = 'none';
        resolve({ error: 'Verbindungsfehler' });
      };
    });
  }

  // Batch Name Validation Function
  function runBatchNameValidation() {
    return new Promise((resolve) => {
      const modal = document.getElementById('name-validation-progress-modal');
      const progressBar = document.getElementById('name-validation-progress-bar');
      const progressText = document.getElementById('name-validation-progress-text');
      const statusText = document.getElementById('name-validation-status-text');

      modal.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = 'Starte...';
      statusText.textContent = '';

      const eventSource = new EventSource('/api/batch-validate-names-stream');

      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'start') {
          progressText.textContent = `0 / ${data.total} Namen`;
        } else if (data.type === 'progress') {
          const percent = Math.round((data.processed / data.total) * 100);
          progressBar.style.width = percent + '%';
          progressText.textContent = `${data.processed} / ${data.total} Namen`;
          if (data.batch && data.batch.length > 0) {
            statusText.textContent = `Pr√ºfe: ${data.batch.slice(0, 3).join(', ')}${data.batch.length > 3 ? '...' : ''}`;
          }
        } else if (data.type === 'complete') {
          progressBar.style.width = '100%';
          progressText.textContent = data.message;
          statusText.textContent = data.flagged > 0
            ? `‚ö†Ô∏è ${data.flagged} von ${data.total} Namen zur Pr√ºfung markiert`
            : `‚úì Alle ${data.total} Namen sind g√ºltig`;
          eventSource.close();
          setTimeout(() => {
            modal.style.display = 'none';
            resolve(data);
          }, 1500);
        } else if (data.type === 'error') {
          progressText.textContent = 'Fehler!';
          statusText.textContent = data.message;
          eventSource.close();
          setTimeout(() => {
            modal.style.display = 'none';
            resolve({ error: data.message });
          }, 2000);
        }
      };

      eventSource.onerror = function() {
        eventSource.close();
        modal.style.display = 'none';
        resolve({ error: 'Verbindungsfehler' });
      };
    });
  }
</script>

<!-- Salutation Progress Modal -->
<div id="salutation-progress-modal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2>ü§ñ Anreden ermitteln</h2>
    </div>
    <div class="modal-body" style="text-align: center; padding: 2rem;">
      <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 24px; margin-bottom: 1rem;">
        <div id="salutation-progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
      </div>
      <p id="salutation-progress-text" style="font-size: 1.1rem; font-weight: 500; margin: 0.5rem 0;">Starte...</p>
      <p id="salutation-status-text" style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;"></p>
    </div>
  </div>
</div>

<!-- Name Validation Progress Modal -->
<div id="name-validation-progress-modal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2>üîç Namen validieren</h2>
    </div>
    <div class="modal-body" style="text-align: center; padding: 2rem;">
      <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 24px; margin-bottom: 1rem;">
        <div id="name-validation-progress-bar" style="background: linear-gradient(90deg, #ff9800, #ffb74d); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
      </div>
      <p id="name-validation-progress-text" style="font-size: 1.1rem; font-weight: 500; margin: 0.5rem 0;">Starte...</p>
      <p id="name-validation-status-text" style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;"></p>
    </div>
  </div>
</div>

<!-- Pending Imports Modal -->
<div id="pending-imports-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>Import √ºberpr√ºfen</h2>
      <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.95rem;">
        Import <span id="pending-current-index">1</span> von <span id="pending-imports-count">0</span>
      </p>
    </div>
    <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
      <div id="pending-imports-list"></div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
      <button id="pending-confirm-btn" class="btn-resolve-footer">
        ‚úì Auswahl best√§tigen
      </button>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button id="pending-prev-btn" class="modal-nav-btn">‚Üê Zur√ºck</button>
        <button id="close-pending-imports-modal" class="modal-close-btn">Sp√§ter</button>
        <button id="pending-next-btn" class="modal-nav-btn">Weiter ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<style>
.pending-import-item {
  background: #fff;
}

.pending-import-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid #f0f0f0;
}

.pending-import-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.15rem;
}

.pending-import-amount {
  font-size: 1.15rem;
  font-weight: bold;
  color: #4CAF50;
}

.pending-import-details {
  margin-bottom: 1rem;
}

.detail-row {
  padding: 0.35rem 0;
  color: #555;
  font-size: 0.9rem;
}

.similar-customers-section {
  margin-top: 1rem;
}

.similar-customers-section h4 {
  margin-bottom: 0.75rem;
  color: #333;
}

.similar-customer-group {
  margin-bottom: 1rem;
  padding: 1rem;
  border: 2px solid #ddd;
  border-radius: 6px;
  background: #fafafa;
}

.comparison-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.comparison-container {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  padding: 1rem;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.comparison-column {
  flex: 1;
  min-width: 0;
}

.comparison-new {
  border-right: 2px solid #e0e0e0;
  padding-right: 1rem;
}

.comparison-existing {
  padding-left: 1rem;
}

.comparison-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.comparison-name {
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.35rem;
}

.comparison-address {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0.2rem;
}

.comparison-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: #999;
  padding: 0 0.5rem;
  min-width: 2rem;
}

.comparison-options {
  display: flex;
  gap: 0.75rem;
}

.comparison-options .similar-customer-option {
  flex: 1;
  margin-bottom: 0;
}

.customer-group-header {
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.customer-group-header strong {
  font-size: 1rem;
  color: #333;
  display: block;
  margin-bottom: 0.15rem;
}

.customer-group-header .customer-address,
.customer-group-header .customer-meta {
  font-size: 0.85rem;
  margin: 0.15rem 0;
}

.similar-customer-option {
  display: flex;
  align-items: flex-start;
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  border: 2px solid #e0e0e0;
  border-radius: 4px;
  background: white;
  transition: all 0.2s;
}

.similar-customer-option:last-child {
  margin-bottom: 0;
}

.similar-customer-option:hover {
  background: #f9f9f9;
  border-color: #4CAF50;
}

.similar-customer-option input[type="radio"] {
  margin-right: 1rem;
  margin-top: 0.25rem;
}

.similar-customer-option input[type="radio"]:checked + label {
  color: #4CAF50;
}

.similar-customer-option label {
  flex: 1;
  cursor: pointer;
}

.customer-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.similarity-score {
  background: #4CAF50;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: bold;
}

.customer-address {
  color: #666;
  font-size: 0.95rem;
  margin-bottom: 0.25rem;
}

.customer-meta {
  color: #999;
  font-size: 0.85rem;
}

.pending-import-actions {
  margin-top: 1rem;
  text-align: center;
}

.btn-resolve, .btn-resolve-footer {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 0.65rem 1.75rem;
  border-radius: 6px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background 0.2s;
  font-weight: 500;
}

.btn-resolve-footer {
  padding: 0.75rem 2rem;
  font-size: 1rem;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  white-space: nowrap;
}

.btn-resolve:hover, .btn-resolve-footer:hover {
  background: #45a049;
}

.btn-resolve:active, .btn-resolve-footer:active {
  background: #3d8b40;
}

/* Diff highlighting */
mark.diff-change {
  background-color: #fff3cd;
  color: #856404;
  padding: 0.1rem 0.2rem;
  border-radius: 2px;
  font-weight: 600;
}

mark.diff-insert {
  background-color: #d4edda;
  color: #155724;
  padding: 0.1rem 0.2rem;
  border-radius: 2px;
  font-weight: 600;
}

mark.diff-delete {
  background-color: #f8d7da;
  color: #721c24;
  padding: 0.1rem 0.2rem;
  border-radius: 2px;
  font-weight: 600;
  text-decoration: line-through;
}

.modal-nav-btn {
  background: #f0f0f0;
  color: #333;
  border: 2px solid #ddd;
  padding: 0.5rem 1.25rem;
  border-radius: 6px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.modal-nav-btn:hover:not(:disabled) {
  background: #e0e0e0;
  border-color: #4CAF50;
}

.modal-nav-btn:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.modal-close-btn {
  background: transparent;
  color: #666;
  border: none;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: color 0.2s;
}

.modal-close-btn:hover {
  color: #333;
  text-decoration: underline;
}

/* Incomplete address warning badge */
.incomplete-address-badge {
  display: inline-block;
  margin-left: 0.5rem;
  padding: 0.2rem 0.5rem;
  background-color: #ff9800;
  color: white;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: help;
  white-space: nowrap;
}

.incomplete-address-badge:hover {
  background-color: #f57c00;
}

/* Name needs review warning badge */
.name-review-badge {
  display: inline-block;
  margin-left: 0.5rem;
  padding: 0.2rem 0.5rem;
  background-color: #ff9800;
  color: white;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: help;
  white-space: nowrap;
}

.name-review-badge:hover {
  background-color: #f57c00;
}
</style>

{% endblock %}
