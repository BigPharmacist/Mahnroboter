{% extends "base.html" %}

{% block title %}Mahnungen{% endblock %}

{% block content %}
<header>
  <h1>Mahnungen</h1>
  <p class="subtitle">Verwaltung von Mahnungen und Zahlungserinnerungen</p>
</header>

<section class="tabs">
  <div class="tab-buttons">
    <a href="{{ url_for('mahnungen', view='unbemahnt') }}"
       class="tab-btn {% if view == 'unbemahnt' %}active{% endif %}">
      <span class="tab-btn-text">Unbemahnt</span>
      <span class="tab-badge">{{ stats.tab_counts.unbemahnt }}</span>
    </a>
    <a href="{{ url_for('mahnungen', view='zahlungserinnerung') }}"
       class="tab-btn {% if view == 'zahlungserinnerung' %}active{% endif %}">
      <span class="tab-btn-text">Zahlungserinnerung</span>
      <span class="tab-badge">{{ stats.tab_counts.zahlungserinnerung }}</span>
    </a>
    <a href="{{ url_for('mahnungen', view='1_mahnung') }}"
       class="tab-btn {% if view == '1_mahnung' %}active{% endif %}">
      <span class="tab-btn-text">1. Mahnung</span>
      <span class="tab-badge">{{ stats.tab_counts['1_mahnung'] }}</span>
    </a>
    <a href="{{ url_for('mahnungen', view='2_mahnung') }}"
       class="tab-btn {% if view == '2_mahnung' %}active{% endif %}">
      <span class="tab-btn-text">2. Mahnung</span>
      <span class="tab-badge">{{ stats.tab_counts['2_mahnung'] }}</span>
    </a>
  </div>
</section>

<section class="stats-summary">
  <div class="stat-card">
    <div class="stat-label">Anzahl Rechnungen</div>
    <div class="stat-value">{{ stats.total_count }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Gesamtbetrag</div>
    <div class="stat-value">{{ "%.2f"|format(stats.total_amount) }} â‚¬</div>
  </div>
  {% if view == 'unbemahnt' %}
  <div class="stat-card">
    <div class="stat-label">Empfohlen: Zahlungserinnerung</div>
    <div class="stat-value">{{ stats.count_by_level.get(0, 0) }}</div>
  </div>
  {% endif %}
</section>

{% if customer_groups %}
<section class="customers-container">
  <div class="collapse-controls">
    <button class="btn btn-secondary btn-sm" onclick="toggleAllGroups()" id="toggleAllBtn">
      Alle einklappen
    </button>
    {% if view == 'unbemahnt' and stats.count_by_level.get(0, 0) > 0 %}
    <button class="btn btn-primary btn-sm" onclick="createAllRecommendedReminders()" style="margin-left: 1rem;">
      Alle Zahlungserinnerungen erstellen ({{ stats.count_by_level.get(0, 0) }})
    </button>
    {% endif %}
    {% if view == 'zahlungserinnerung' and stats.total_count > 0 %}
    <button class="btn btn-primary btn-sm" onclick="createAllFirstReminders()" style="margin-left: 1rem;">
      Alle 1. Mahnungen erstellen ({{ stats.total_count }})
    </button>
    {% endif %}
    {% if view == '1_mahnung' and stats.total_count > 0 %}
    <button class="btn btn-primary btn-sm" onclick="createAllSecondReminders()" style="margin-left: 1rem;">
      Alle 2. Mahnungen erstellen ({{ stats.total_count }})
    </button>
    {% endif %}
  </div>
  {% for customer in customer_groups %}
  <div class="customer-group">
    <div class="customer-header">
      <div class="customer-info" onclick="toggleCustomerGroup(event.target.closest('.customer-header'))">
        <h3>{{ customer.customer_name }}</h3>
        <small class="muted">{{ customer.customer_address }}</small>
      </div>
      <div class="customer-summary">
        <span class="summary-text">
          {{ customer.invoices|length }} Rechnung{{ 'en' if customer.invoices|length != 1 else '' }},
          {{ "%.2f"|format(customer.invoices|sum(attribute='amount_eur')) }} â‚¬
        </span>
      </div>
      {% if view != '2_mahnung' %}
      <button class="btn btn-primary btn-sm" onclick="createBulkReminders('{{ customer.customer_name }}', event)">
        {% if view == 'unbemahnt' %}Mahnung erstellen{% else %}Eskalieren{% endif %}
      </button>
      {% endif %}
      <span class="collapse-icon" onclick="toggleCustomerGroup(event.target.closest('.customer-header'))">â–¼</span>
    </div>

    <div class="customer-invoices">
      <table class="invoice-table">
      <thead>
        <tr>
          {% if view != '2_mahnung' %}
          <th style="width: 30px;">
            <input type="checkbox" onchange="toggleAllInvoices(this, '{{ customer.customer_name }}')" title="Alle auswÃ¤hlen">
          </th>
          {% endif %}
          <th>#</th>
          <th>Rechnungsnr.</th>
          <th>Rechnungsdatum</th>
          <th>Monate offen</th>
          <th>Betrag</th>
          {% if view == 'unbemahnt' %}
          <th>Empfehlung</th>
          {% elif view != 'unbemahnt' %}
          <th>Status</th>
          <th>Gesendet am</th>
          {% endif %}
          <th>PDF</th>
        </tr>
      </thead>
      <tbody>
        {% if view == 'unbemahnt' %}
          {# For unbemahnt view, show simple list #}
          {% for invoice in customer.invoices %}
          <tr class="{% if invoice.recommended_level is none %}too-young{% elif invoice.months_open >= 4 %}urgent{% elif invoice.months_open >= 3 %}warning{% endif %}">
            <td>
              {% if invoice.recommended_level is not none %}
                <input type="checkbox"
                       class="invoice-checkbox"
                       data-customer="{{ customer.customer_name }}"
                       data-invoice-id="{{ invoice.id }}"
                       data-level="{{ invoice.recommended_level }}">
              {% endif %}
            </td>
            <td class="row-number">{{ loop.index }}</td>
            <td>{{ invoice.invoice_number or 'â€”' }}</td>
            <td>{{ invoice.invoice_date|german_date }}</td>
            <td>
              <span class="badge {% if invoice.months_open >= 4 %}badge-danger{% elif invoice.months_open >= 3 %}badge-warning{% elif invoice.months_open >= 2 %}badge-info{% endif %}">
                {{ invoice.months_open }} Monate
              </span>
            </td>
            <td class="amount">{{ "%.2f"|format(invoice.amount_eur) }} â‚¬</td>
            <td>
              {% if invoice.recommended_level == 0 %}
                <span class="badge badge-info">Zahlungserinnerung</span>
              {% elif invoice.recommended_level == 1 %}
                <span class="badge badge-warning">1. Mahnung</span>
              {% elif invoice.recommended_level == 2 %}
                <span class="badge badge-danger">2. Mahnung (Einschreiben)</span>
              {% else %}
                <span class="muted">â€”</span>
              {% endif %}
            </td>
            <td>
              {% if invoice.file_path %}
                <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}"
                   target="_blank" class="btn-link">Rechnungs-PDF</a>
              {% else %}
                <span class="muted">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          {# For reminder views, show grouped invoices #}
          {% set row_num = namespace(value=0) %}
          {% for group in customer.invoice_groups %}
            {% if group.is_group %}
              {# Multiple invoices bundled together #}
              {% set row_num.value = row_num.value + 1 %}
              <tr class="invoice-group-header" onclick="toggleInvoiceGroup(this)">
                {% if view != '2_mahnung' %}
                <td></td>
                {% endif %}
                <td class="row-number">{{ row_num.value }}</td>
                <td colspan="2">
                  <strong>ðŸ“Ž {{ group.count }} Rechnungen zusammengefasst</strong>
                  <span class="expand-icon">â–¼</span>
                </td>
                <td></td>
                <td class="amount"><strong>{{ "%.2f"|format(group.total_amount) }} â‚¬</strong></td>
                <td>
                  {% set first_inv = group.invoices[0] %}
                  {% if first_inv.last_reminder_level == 0 %}
                    <span class="badge badge-info">Zahlungserinnerung</span>
                  {% elif first_inv.last_reminder_level == 1 %}
                    <span class="badge badge-warning">1. Mahnung</span>
                  {% elif first_inv.last_reminder_level == 2 %}
                    <span class="badge badge-danger">2. Mahnung</span>
                  {% endif %}
                </td>
                <td>{{ first_inv.last_reminder_date|german_date if first_inv.last_reminder_date else 'â€”' }}</td>
                <td>
                  {% if group.reminder_pdf_path %}
                    <a href="{{ url_for('serve_pdf', relative_path=group.reminder_pdf_path) }}"
                       target="_blank" class="btn-link" onclick="event.stopPropagation()">Mahnungs-PDF</a>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
              {# Individual invoices in group (collapsed by default) #}
              {% for invoice in group.invoices %}
              <tr class="invoice-group-detail" style="display: none;">
                {% if view != '2_mahnung' %}
                <td>
                  {% if view == 'zahlungserinnerung' %}
                    <input type="checkbox"
                           class="invoice-checkbox"
                           data-customer="{{ customer.customer_name }}"
                           data-invoice-id="{{ invoice.id }}"
                           data-level="1"
                           onclick="event.stopPropagation()">
                  {% elif view == '1_mahnung' %}
                    <input type="checkbox"
                           class="invoice-checkbox"
                           data-customer="{{ customer.customer_name }}"
                           data-invoice-id="{{ invoice.id }}"
                           data-level="2"
                           onclick="event.stopPropagation()">
                  {% endif %}
                </td>
                {% endif %}
                <td></td>
                <td style="padding-left: 2rem;">{{ invoice.invoice_number or 'â€”' }}</td>
                <td>{{ invoice.invoice_date|german_date }}</td>
                <td>
                  <span class="badge {% if invoice.months_open >= 4 %}badge-danger{% elif invoice.months_open >= 3 %}badge-warning{% elif invoice.months_open >= 2 %}badge-info{% endif %}">
                    {{ invoice.months_open }} Monate
                  </span>
                </td>
                <td class="amount">{{ "%.2f"|format(invoice.amount_eur) }} â‚¬</td>
                <td></td>
                <td></td>
                <td>
                  {% if invoice.file_path %}
                    <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}"
                       target="_blank" class="btn-link" onclick="event.stopPropagation()">Rechnungs-PDF</a>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% else %}
              {# Single invoice - display with same style as groups #}
              {% set row_num.value = row_num.value + 1 %}
              {% set invoice = group.invoices[0] %}
              <tr class="invoice-group-header" onclick="toggleInvoiceGroup(this)">
                {% if view != '2_mahnung' %}
                <td>
                  {% if view == 'zahlungserinnerung' %}
                    <input type="checkbox"
                           class="invoice-checkbox"
                           data-customer="{{ customer.customer_name }}"
                           data-invoice-id="{{ invoice.id }}"
                           data-level="1"
                           onclick="event.stopPropagation()">
                  {% elif view == '1_mahnung' %}
                    <input type="checkbox"
                           class="invoice-checkbox"
                           data-customer="{{ customer.customer_name }}"
                           data-invoice-id="{{ invoice.id }}"
                           data-level="2"
                           onclick="event.stopPropagation()">
                  {% endif %}
                </td>
                {% endif %}
                <td class="row-number">{{ row_num.value }}</td>
                <td colspan="2">
                  <strong>{{ invoice.invoice_number or 'â€”' }}</strong>
                  <span class="expand-icon">â–¼</span>
                </td>
                <td></td>
                <td class="amount"><strong>{{ "%.2f"|format(invoice.amount_eur) }} â‚¬</strong></td>
                <td>
                  {% if invoice.last_reminder_level == 0 %}
                    <span class="badge badge-info">Zahlungserinnerung</span>
                  {% elif invoice.last_reminder_level == 1 %}
                    <span class="badge badge-warning">1. Mahnung</span>
                  {% elif invoice.last_reminder_level == 2 %}
                    <span class="badge badge-danger">2. Mahnung</span>
                  {% endif %}
                  {% if invoice.letterexpress_status %}
                    <br><small class="muted">{{ invoice.letterexpress_status }}</small>
                  {% endif %}
                </td>
                <td>{{ invoice.last_reminder_date|german_date if invoice.last_reminder_date else 'â€”' }}</td>
                <td>
                  {% if invoice.reminder_pdf_path %}
                    <a href="{{ url_for('serve_pdf', relative_path=invoice.reminder_pdf_path) }}"
                       target="_blank" class="btn-link" onclick="event.stopPropagation()">Mahnungs-PDF</a>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
              {# Detail row for single invoice - expanded by default #}
              <tr class="invoice-group-detail single-invoice-detail">
                {% if view != '2_mahnung' %}
                <td></td>
                {% endif %}
                <td></td>
                <td style="padding-left: 2rem;">{{ invoice.invoice_number or 'â€”' }}</td>
                <td>{{ invoice.invoice_date|german_date }}</td>
                <td>
                  <span class="badge {% if invoice.months_open >= 4 %}badge-danger{% elif invoice.months_open >= 3 %}badge-warning{% elif invoice.months_open >= 2 %}badge-info{% endif %}">
                    {{ invoice.months_open }} Monate
                  </span>
                </td>
                <td class="amount">{{ "%.2f"|format(invoice.amount_eur) }} â‚¬</td>
                <td></td>
                <td></td>
                <td>
                  {% if invoice.file_path %}
                    <a href="{{ url_for('serve_pdf', relative_path=invoice.file_path) }}"
                       target="_blank" class="btn-link" onclick="event.stopPropagation()">Rechnungs-PDF</a>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
    </div>
  </div>
  {% endfor %}
</section>
{% else %}
<section class="empty-state">
  <div class="info-card">
    <span class="info-icon">âœ“</span>
    <div class="info-content">
      <h2>Keine Rechnungen</h2>
      <p>
        {% if view == 'unbemahnt' %}
        Aktuell gibt es keine offenen Rechnungen, die noch nicht gemahnt wurden.
        {% elif view == 'zahlungserinnerung' %}
        Es gibt keine Rechnungen mit Zahlungserinnerung.
        {% elif view == '1_mahnung' %}
        Es gibt keine Rechnungen mit 1. Mahnung.
        {% elif view == '2_mahnung' %}
        Es gibt keine Rechnungen mit 2. Mahnung.
        {% endif %}
      </p>
    </div>
  </div>
</section>
{% endif %}

<!-- Progress Modal -->
<div id="progressModal" class="progress-modal">
  <div class="progress-modal-content">
    <div class="spinner"></div>
    <p id="progressMessage">Verarbeite...</p>
  </div>
</div>

<script>
function toggleInvoiceGroup(headerRow) {
  const detailRows = [];
  let nextRow = headerRow.nextElementSibling;

  while (nextRow && nextRow.classList.contains('invoice-group-detail')) {
    detailRows.push(nextRow);
    nextRow = nextRow.nextElementSibling;
  }

  const expandIcon = headerRow.querySelector('.expand-icon');

  // Check if this is a single invoice (has single-invoice-detail class)
  const isSingleInvoice = detailRows.length > 0 && detailRows[0].classList.contains('single-invoice-detail');

  if (isSingleInvoice) {
    // Single invoices are always visible (CSS !important),
    // but we still rotate the icon for visual feedback
    // Do nothing - single invoices stay expanded
    return;
  }

  // For groups, toggle visibility
  const isExpanded = detailRows.length > 0 && detailRows[0].style.display !== 'none';

  detailRows.forEach(row => {
    row.style.display = isExpanded ? 'none' : 'table-row';
  });

  if (expandIcon) {
    expandIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
  }
}

function toggleAllInvoices(checkbox, customerName) {
  const checkboxes = document.querySelectorAll(
    `.invoice-checkbox[data-customer="${customerName}"]`
  );
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function createBulkReminders(customerName, event) {
  event.stopPropagation();

  const checkboxes = document.querySelectorAll(
    `.invoice-checkbox[data-customer="${customerName}"]:checked`
  );

  if (checkboxes.length === 0) {
    alert('Bitte wÃ¤hlen Sie mindestens eine Rechnung aus.');
    return;
  }

  const invoices = Array.from(checkboxes).map(cb => ({
    invoice_id: parseInt(cb.dataset.invoiceId),
    reminder_level: parseInt(cb.dataset.level)
  }));

  const levelNames = {
    0: 'Zahlungserinnerung',
    1: '1. Mahnung',
    2: '2. Mahnung (Einschreiben)'
  };

  const summary = invoices.reduce((acc, inv) => {
    const levelName = levelNames[inv.reminder_level];
    acc[levelName] = (acc[levelName] || 0) + 1;
    return acc;
  }, {});

  const summaryText = Object.entries(summary)
    .map(([level, count]) => `${count}x ${level}`)
    .join(', ');

  if (!confirm(`MÃ¶chten Sie wirklich ${invoices.length} Mahnung(en) erstellen?\n\n${summaryText}`)) {
    return;
  }

  fetch('/api/reminders/bulk', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ invoices })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`${data.created_pdfs} Mahnung(en) wurden erfolgreich erstellt mit ${data.created_reminders} Rechnungen!`);
      location.reload();
    } else {
      alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    alert('Fehler beim Erstellen der Mahnungen: ' + error);
  });
}

function toggleCustomerGroup(header) {
  const group = header.closest('.customer-group');
  group.classList.toggle('collapsed');
  updateToggleAllButton();
}

function toggleAllGroups() {
  const allGroups = document.querySelectorAll('.customer-group');
  const btn = document.getElementById('toggleAllBtn');
  const anyExpanded = Array.from(allGroups).some(group => !group.classList.contains('collapsed'));

  allGroups.forEach(group => {
    if (anyExpanded) {
      group.classList.add('collapsed');
    } else {
      group.classList.remove('collapsed');
    }
  });

  updateToggleAllButton();
}

function updateToggleAllButton() {
  const allGroups = document.querySelectorAll('.customer-group');
  const btn = document.getElementById('toggleAllBtn');
  const anyExpanded = Array.from(allGroups).some(group => !group.classList.contains('collapsed'));

  if (anyExpanded) {
    btn.textContent = 'Alle einklappen';
  } else {
    btn.textContent = 'Alle ausklappen';
  }
}

function createAllRecommendedReminders() {
  // Find all checkboxes with data-level="0" (Zahlungserinnerung recommendations)
  const checkboxes = document.querySelectorAll('.invoice-checkbox[data-level="0"]');

  if (checkboxes.length === 0) {
    alert('Keine Zahlungserinnerungen zu erstellen.');
    return;
  }

  // Collect all invoices with their data
  const invoices = Array.from(checkboxes).map(cb => ({
    invoice_id: parseInt(cb.dataset.invoiceId),
    reminder_level: 0
  }));

  // Calculate statistics: unique customers
  const uniqueCustomers = new Set(
    Array.from(checkboxes).map(cb => cb.dataset.customer)
  );

  // Show confirmation dialog
  const confirmMessage = `${invoices.length} Rechnungen von ${uniqueCustomers.size} Kunden werden mit einer Zahlungserinnerung versehen.\n\nMÃ¶chten Sie fortfahren?`;

  if (!confirm(confirmMessage)) {
    return;
  }

  // Show loading modal
  showProgressModal(`Erstelle ${invoices.length} Zahlungserinnerung(en)...`);

  // Make API call to create bulk reminders
  fetch('/api/reminders/bulk', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ invoices })
  })
  .then(response => response.json())
  .then(data => {
    hideProgressModal();
    if (data.success) {
      let message = `${data.created_pdfs} Zahlungserinnerung(en) wurden erfolgreich erstellt mit ${data.created_reminders} Rechnungen!`;
      if (data.skipped_paid > 0) {
        message += `\n\nHinweis: ${data.skipped_paid} bereits bezahlte Rechnung(en) wurden Ã¼bersprungen.`;
      }
      alert(message);
      location.reload();
    } else {
      alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    hideProgressModal();
    alert('Fehler beim Erstellen der Zahlungserinnerungen: ' + error);
  });
}

function createAllFirstReminders() {
  // Find all checkboxes with data-level="1" (1. Mahnung)
  const checkboxes = document.querySelectorAll('.invoice-checkbox[data-level="1"]');

  if (checkboxes.length === 0) {
    alert('Keine 1. Mahnungen zu erstellen.');
    return;
  }

  // Collect all invoices with their data
  const invoices = Array.from(checkboxes).map(cb => ({
    invoice_id: parseInt(cb.dataset.invoiceId),
    reminder_level: 1
  }));

  // Calculate statistics: unique customers
  const uniqueCustomers = new Set(
    Array.from(checkboxes).map(cb => cb.dataset.customer)
  );

  // Show confirmation dialog
  const confirmMessage = `${invoices.length} Rechnungen von ${uniqueCustomers.size} Kunden werden mit einer 1. Mahnung versehen.\n\nMÃ¶chten Sie fortfahren?`;

  if (!confirm(confirmMessage)) {
    return;
  }

  // Show loading modal
  showProgressModal(`Erstelle ${invoices.length} 1. Mahnung(en)...`);

  // Make API call to create bulk reminders
  fetch('/api/reminders/bulk', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ invoices })
  })
  .then(response => response.json())
  .then(data => {
    hideProgressModal();
    if (data.success) {
      let message = `${data.created_pdfs} 1. Mahnung(en) wurden erfolgreich erstellt mit ${data.created_reminders} Rechnungen!`;
      if (data.skipped_paid > 0) {
        message += `\n\nHinweis: ${data.skipped_paid} bereits bezahlte Rechnung(en) wurden Ã¼bersprungen.`;
      }
      alert(message);
      location.reload();
    } else {
      alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    hideProgressModal();
    alert('Fehler beim Erstellen der 1. Mahnungen: ' + error);
  });
}

function createAllSecondReminders() {
  // Find all checkboxes with data-level="2" (2. Mahnung)
  const checkboxes = document.querySelectorAll('.invoice-checkbox[data-level="2"]');

  if (checkboxes.length === 0) {
    alert('Keine 2. Mahnungen zu erstellen.');
    return;
  }

  // Collect all invoices with their data
  const invoices = Array.from(checkboxes).map(cb => ({
    invoice_id: parseInt(cb.dataset.invoiceId),
    reminder_level: 2
  }));

  // Calculate statistics: unique customers
  const uniqueCustomers = new Set(
    Array.from(checkboxes).map(cb => cb.dataset.customer)
  );

  // Show confirmation dialog
  const confirmMessage = `${invoices.length} Rechnungen von ${uniqueCustomers.size} Kunden werden mit einer 2. Mahnung (Einschreiben) versehen.\n\nMÃ¶chten Sie fortfahren?`;

  if (!confirm(confirmMessage)) {
    return;
  }

  // Show loading modal
  showProgressModal(`Erstelle ${invoices.length} 2. Mahnung(en) (Einschreiben)...`);

  // Make API call to create bulk reminders
  fetch('/api/reminders/bulk', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ invoices })
  })
  .then(response => response.json())
  .then(data => {
    hideProgressModal();
    if (data.success) {
      let message = `${data.created_pdfs} 2. Mahnung(en) wurden erfolgreich erstellt mit ${data.created_reminders} Rechnungen!`;
      if (data.skipped_paid > 0) {
        message += `\n\nHinweis: ${data.skipped_paid} bereits bezahlte Rechnung(en) wurden Ã¼bersprungen.`;
      }
      alert(message);
      location.reload();
    } else {
      alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    hideProgressModal();
    alert('Fehler beim Erstellen der 2. Mahnungen: ' + error);
  });
}

function showProgressModal(message) {
  const modal = document.getElementById('progressModal');
  const modalMessage = document.getElementById('progressMessage');
  modalMessage.textContent = message;
  modal.style.display = 'flex';
}

function hideProgressModal() {
  const modal = document.getElementById('progressModal');
  modal.style.display = 'none';
}
</script>

<style>
.tabs {
  margin: 1.5rem 0;
}

.tab-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
}

.tab-btn {
  position: relative;
  padding: 1.25rem 1.5rem;
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  text-decoration: none;
  color: #666;
  transition: all 0.2s;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  border-color: #123C69;
}

.tab-btn.active {
  background: #123C69;
  color: white;
  border-color: #123C69;
  font-weight: 600;
}

.tab-badge {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: #dc3545;
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  min-width: 1.5rem;
  text-align: center;
}

.tab-btn.active .tab-badge {
  background: white;
  color: #123C69;
}

.stats-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0.75rem;
  margin: 1rem 0;
}

.stat-card {
  background: white;
  padding: 0.75rem;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.stat-label {
  font-size: 0.75rem;
  color: #666;
  line-height: 1.3;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #123C69;
  line-height: 1;
}

.customers-container {
  margin: 1rem 0;
}

.collapse-controls {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 0.75rem;
}

.customer-group {
  background: white;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
  margin-bottom: 1rem;
}

.customer-header {
  background: #f8f9fa;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  transition: background 0.2s;
}

.customer-header:hover {
  background: #e9ecef;
}

.customer-info {
  flex: 1;
  cursor: pointer;
}

.customer-header h3 {
  margin: 0 0 0.25rem 0;
  color: #123C69;
  font-size: 1rem;
}

.customer-header .muted {
  display: block;
  font-size: 0.8rem;
}

.customer-summary {
  opacity: 0;
  max-width: 0;
  overflow: hidden;
  transition: opacity 0.3s, max-width 0.3s;
  white-space: nowrap;
}

.customer-group.collapsed .customer-summary {
  opacity: 1;
  max-width: 300px;
  margin-right: 1rem;
}

.summary-text {
  font-size: 0.85rem;
  color: #666;
  font-weight: 500;
}

.collapse-icon {
  transition: transform 0.2s;
  font-size: 0.9rem;
  color: #666;
  margin-left: 1rem;
  flex-shrink: 0;
  cursor: pointer;
}

.customer-group.collapsed .collapse-icon {
  transform: rotate(-90deg);
}

.customer-invoices {
  max-height: 5000px;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.customer-group.collapsed .customer-invoices {
  max-height: 0;
}

.invoice-table-container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
  margin: 2rem 0;
}

.invoice-table {
  width: 100%;
  border-collapse: collapse;
}

.invoice-table th {
  background: #f8f9fa;
  padding: 0.5rem 0.75rem;
  text-align: left;
  font-weight: 600;
  font-size: 0.85rem;
  color: #333;
  border-bottom: 1px solid #e0e0e0;
}

.invoice-table td {
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid #e0e0e0;
  font-size: 0.9rem;
}

.invoice-table tbody tr:hover {
  background: #f8f9fa;
}

.invoice-table tr.warning {
  background: #fff3cd;
}

.invoice-table tr.urgent {
  background: #f8d7da;
}

.invoice-table tr.too-young {
  background: #d4edda;
}

.badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-info {
  background: #cfe2ff;
  color: #084298;
}

.badge-warning {
  background: #fff3cd;
  color: #664d03;
}

.badge-danger {
  background: #f8d7da;
  color: #842029;
}

.amount {
  font-weight: 600;
  text-align: right;
}

.muted {
  color: #6c757d;
  font-size: 0.875rem;
}

.btn {
  padding: 0.5rem 1rem;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-size: 0.875rem;
  transition: all 0.2s;
}

.btn-primary {
  background: #123C69;
  color: white;
}

.btn-primary:hover {
  background: #0d2d4f;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.813rem;
}

.btn-link {
  color: #123C69;
  text-decoration: none;
}

.btn-link:hover {
  text-decoration: underline;
}

.empty-state {
  margin: 3rem 0;
}

.info-card {
  background: white;
  padding: 3rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  text-align: center;
}

.info-icon {
  font-size: 4rem;
  display: block;
  margin-bottom: 1rem;
}

.info-content h2 {
  margin: 1rem 0;
  color: #333;
}

.info-content p {
  color: #666;
  line-height: 1.6;
}

.invoice-group-header {
  background: #e3f2fd !important;
  cursor: pointer;
  font-weight: 500;
}

.invoice-group-header:hover {
  background: #bbdefb !important;
}

.invoice-group-detail {
  background: #f8f9fa;
}

.invoice-group-detail td {
  font-size: 0.85rem;
  color: #666;
}

.expand-icon {
  display: inline-block;
  margin-left: 0.5rem;
  transition: transform 0.2s;
  font-size: 0.8rem;
  color: #666;
}

.single-invoice-detail {
  display: table-row !important;
}

.invoice-group-header:has(+ .single-invoice-detail) .expand-icon {
  transform: rotate(180deg);
}

/* Progress Modal */
.progress-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
}

.progress-modal-content {
  background-color: white;
  padding: 3rem 4rem;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  text-align: center;
  min-width: 300px;
}

.progress-modal-content p {
  margin: 1.5rem 0 0 0;
  font-size: 1.1rem;
  color: #333;
  font-weight: 500;
}

/* Spinner Animation */
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #123C69;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

{% endblock %}
